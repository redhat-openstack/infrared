---
- name: Check if running inside virtualenv
  command: |
      {{ ansible_python_interpreter | default('python') }} -c "import sys; print(True if hasattr(sys, 'real_prefix') else False)"
  register: is_venv

- set_fact:
    py3_environment: "{{ (ansible_distribution in ['CentOS', 'RedHat']) and (ansible_distribution_major_version | int >= 8) }}"

- name: install virtualenv requirments for pip
  become: yes
  package:
      name:
        - gcc
        - "{{ (py3_environment | bool) | ternary('python3-devel', 'python-devel') }}"
        - "{{ (py3_environment | bool) | ternary('python3-setuptools', 'python-setuptools') }}"
        - libffi-devel
      state: present

- block:
    - name: Download get-pip.py
      get_url:
        url: "https://bootstrap.pypa.io/get-pip.py"
        dest: "/tmp/get-pip.py"
        mode: 0755
        force: yes
        validate_certs: no
      register: get_pip

    - name: Install pip using get-pip.py
      command: "{{ ansible_python_interpreter | default('python') }} {{ get_pip.dest }}"
      become: true
  when: py3_environment | bool
  tags: install-pip


#TODO(aopincar): Check if there is a reason not install pip from source only
- name: install pip using easy_install
  become: yes
  easy_install:
      name: pip
  when: not py3_environment | bool
  tags: install-pip

- name: install virtualenv pip module
  environment:
     PATH: "{{ ansible_env.PATH }}:/usr/local/bin"
  pip:
      name: virtualenv
      state: forcereinstall
      extra_args: "{{ (is_venv.stdout | bool) | ternary(omit, '--user') }}"

# required to avoid any conflicts in venv with
# different packages versions (especially shade)
- name: cleanup shade venv if present
  become: yes
  file:
      state: absent
      path: "{{ shade_path_venv }}"

# installing setuptools and pip must happen before other packages and separated
# do not use shimming for these two special packages
- name: shade virtualenv core deps
  vars:
      venv_cmd: "{{ ansible_env.HOME }}/.local/bin/virtualenv"
  pip:
      name: "{{ item }}"
      virtualenv: "{{ shade_path_venv }}"
      virtualenv_command: "{{ (is_venv.stdout | bool) | ternary(omit, venv_cmd) }}"
  with_items:
    # workaround for https://github.com/pypa/setuptools/issues/1990
    - "setuptools>39.0.0,<45.2.0"
    - "pip>=10.0.1"

- name: shade virtualenv deps
  vars:
      venv_cmd: "{{ ansible_env.HOME }}/.local/bin/virtualenv"
  pip:
      # On RHEL7 we need to pin to < 0.40.0 because that's when py2
      # testing was removed.
      name: "{{ (py3_environment | bool) | ternary('openstacksdk>=0.29.0', 'openstacksdk>=0.29.0,<0.40.0') }}"
      virtualenv: "{{ shade_path_venv }}"
      virtualenv_command: "{{ (is_venv.stdout | bool) | ternary(omit, venv_cmd) }}"
