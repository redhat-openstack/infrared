---
- name: Install packages required for 'pxe_ipmitool' ironic's driver on RedHat based distros
  become: true
  package:
      name:
        - python-setuptools
        - ipmitool
      state: latest
      disable_gpg_check: yes

- name: Install python-virtualbmc from repo's
  become: true
  package:
      name: python-virtualbmc
      state: latest
      disable_gpg_check: yes
  ignore_errors: yes
  register: virtualbmc_install_result

- block:
    - name: Install packages required for python-virtualbmc pip package
      become: true
      package:
          name:
            - gcc
            - libvirt
            - libvirt-devel
            - python-devel
          state: latest
          disable_gpg_check: yes

    - name: install pip
      become: yes
      easy_install:
          name: pip

    - name: Install python-virtualbmc with pip
      become: true
      pip:
          name: virtualbmc
          state: latest
  when: virtualbmc_install_result|failed

- name: Apply the vbmc patch - w/a for BZ1571384
  shell: |
    GIT_SSL_NO_VERIFY=true git clone https://review.openstack.org/openstack/virtualbmc.git
    pushd virtualbmc
    GIT_SSL_NO_VERIFY=true git fetch https://git.openstack.org/openstack/virtualbmc refs/changes/78/564878/5 && git checkout FETCH_HEAD
    virtualenv venv2
    . venv2/bin/activate
    pip install -e .
    systemctl stop virtualbmc
    for domain in $(ls ~/.vbmc)
    do
       vbmc start $domain
    done
  delegate_to: hypervisor
  become: yes

