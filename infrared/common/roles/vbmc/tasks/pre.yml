- block:
  - name: Remove package if installed from rpm
    package:
        name: "{{ item }}"
        state: absent
    with_items:
        - python-virtualbmc
        - python2-virtualbmc
    changed_when: false
    failed_when: false

  # pip can be missing on a target host.
  # so ignore errors and cleanup as much as possible
  - name: Remove package if installed from pip
    pip:
        name: virtualbmc
        state: absent
    changed_when: false
    failed_when: false

  - name: delete scripts and configuration files
    file:
        path: "{{ item }}"
        state: absent
    with_items:
        - /usr/lib/systemd/system/virtualbmc.service
        - "{{ vbmc_config_dir }}"
    ignore_errors: true

  - name: Install packages required for python-virtualbmc pip package
    package:
        name:
          - gcc
          - libvirt
          - libvirt-devel
          - python-devel
        state: latest
        disable_gpg_check: yes

  - name: Delete pip installation file
    file:
        path: "{{ vbmc_home }}/get-pip.py"
        state: absent

  - name: Download pip installation file
    get_url:
        url: https://bootstrap.pypa.io/get-pip.py
        dest: "{{ vbmc_home }}/get-pip.py"
    register: result
    until: "'OK' in result.msg"
    retries: 5
    delay: 10

  - name: Install pip
    shell: "python {{ vbmc_home }}/get-pip.py"
    register: pip_install
    failed_when: "'Successfully installed' not in pip_install.stdout"

  - name: install virtualenv pip module
    pip:
        name: virtualenv
        extra_args: "--user"

  become: yes
