---
- name: setup facts directory on inventory hosts
  file:
    path: "{{ ansible_facts_dir }}"
    state: "{{ item }}"
  with_items:
    - absent
    - directory

- name: save ansible facts in json file
  copy:
    content: "{{ hostvars[inventory_hostname] | to_nice_json }}"
    dest: "{{ ansible_facts_dir }}/{{ansible_facts_filename}}{{ inventory_hostname }}.json"

- name: setup facts directory on localhost
  file:
    path: "{{ ansible_facts_dir_host }}"
    state: "{{ item }}"
  when: inventory_hostname == 'localhost'
  with_items:
    - absent
    - directory

- name: fetch ansible facts file from inventory hosts
  fetch:
    src: "{{ ansible_facts_dir }}/{{ansible_facts_filename}}{{ inventory_hostname }}.json"
    dest: "{{ ansible_facts_dir_host }}/"
    flat: yes