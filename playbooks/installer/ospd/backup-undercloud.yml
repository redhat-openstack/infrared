- name: Make a copy of our undercloud for virthost installation
  hosts: virthost
  gather_facts: no
  vars:
      undercloud: "{{ hostvars[(groups.undercloud|first)].inventory_hostname }}"
  tasks:
      - name: shutdown the undercloud VM
        virt:
            name: "{{ undercloud }}"
            state: shutdown

      - name: create a copy from the VM xml
        virt:
            name: "{{ undercloud }}"
            command: get_xml
        register: undercloud_xml

      - name: save undercloud xml to file
        copy:
            content: "{{ undercloud_xml.get_xml }}"
            dest: "/tmp/{{ undercloud }}.xml"

      - name: copy the undercloud disk
        shell: "cp -pv /var/lib/libvirt/images/{{ undercloud }}-disk1.qcow2 /tmp/"

      - name: tar our undercloud files
        shell: "tar -cvf undercloud-quickstart.tar /tmp/{{ undercloud }}.xml /tmp/{{ undercloud }}-disk1.qcow2"

      - name: copy our auth key to the virthost
        copy:
            src: "{{ provisioner.host.key }}"
            dest: "~/backup_server_auth_key"
            mode: "0400"

      - name: copy our image to the backup server
        shell: "scp -o StrictHostKeyChecking=no -i ~/backup_server_auth_key undercloud-quickstart.tar {{ private.mirror.user.name }}@{{ private.mirror.base_url | regex_replace('http(s)?://(?P<domain>.*?)(?P<uri>/.*$)', '\\g<domain>:~\\g<uri>') }}/undercloud-quickstart.tar"

      - name: cleanup our files
        shell: "rm -f {{ undercloud }}.xml {{ undercloud }}-disk1.qcow2 undercloud-quickstart.tar"
