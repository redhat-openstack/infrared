---
- include: pre.yml

- name: Setup our undercloud
  include: undercloud/main.yml

- include: overcloud-regular.yml
  when: "installer.roles.data is not defined"

- include: overcloud-roles.yml
  when: "installer.roles.data is defined" 

# Since OSP-d reprovision our machines (overcloud) and becomes the DHCP server, an update of our inventory is required
# So Ansible will be able to access the newly provisioned machines.
# The inventory also gets updated when the deployment fails in order to be able to run log-collection
- include: ospd_inventory_update.yml
  tags:
      - overcloud
      - inventory_update
      - overcloud_deploy

- name: Deploy OverCloud post verify
  tags:
      - overcloud
      - overcloud_deploy
  hosts: undercloud
  gather_facts: no
  any_errors_fatal: true
  tasks:
      - fail: msg="Overcloud deployment failed... :("
        when: overcloud_deploy_registered.rc != 0

      - name: verify overcloudrc was created
        wait_for:
            path: "/home/stack/overcloudrc"
            state: present
            timeout: 60

- name: "Set selinux state on overcloud"
  hosts: overcloud_nodes
  become: yes
  gather_facts: no
  any_errors_fatal: true
  tasks:
      - selinux:
            policy: "targeted"
            state: "{{ installer.selinux | default('enforcing') }}"
        when: installer.product.version|openstack_distribution == 'OSP'

- include: post_install/lbaas_v2.yml
  tags: lbaas
  when: installer.network.lbaas|default('no') == 'yes'

- include: post_install/create_external_network.yml
  tags: public_network
  when: installer.public.network == 'yes'
