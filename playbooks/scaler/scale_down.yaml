---
- name: Removing compute node
  hosts: undercloud
  become: yes
  become_user: stack
  gather_facts: no
  tasks:
      - name: change list of nodes
        shell: "sed -i 's/--compute-scale\ 2/--compute-scale\ 1/g' ~/overcloud_deploy.sh"
        register: export_files

      - name: execute the overcloud deploy script (should take ~30 minutes :) )
        shell: "bash ~/overcloud_scaling.sh"
        register: overcloud_scaling
        ignore_errors: yes

      - name: print the last few lines of the output to spot failures
        shell: "tail -n30 overcloud_scaling.log"

      - fail: msg="Overcloud scailing failed... :("
        when: overcloud_scaling.rc != 0

      - name: change list of nodes
        shell: "sed -i 's/--compute-scale\ 1/--compute-scale\ 2/g' ~/overcloud_deploy.sh"
        register: export_files

      - name: execute the overcloud deploy script (should take ~30 minutes :) )
        shell: "bash ~/overcloud_scaling.sh"
        register: overcloud_scaling
        ignore_errors: yes

      - name: print the last few lines of the output to spot failures
        shell: "tail -n30 overcloud_scaling.log"

      - fail: msg="Overcloud scailing failed... :("
        when: overcloud_scaling.rc != 0