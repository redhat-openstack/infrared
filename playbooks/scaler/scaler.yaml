---
- name: Scaling compute nodes
  hosts: undercloud
  become: yes
  become_user: stack
  gather_facts: no
  vars:
      up_limit: 2
      down_limit: 1
  tasks:
      - name: Create backup copy of overcloud deply script
        shell: "cp -pv  ~/overcloud_deploy.sh ~/overcloud_deploy.sh.bak"

      - name: change list of nodes
        lineinfile:
            dest: "~/overcloud_deploy.sh"
            regexp: '^                       --{{ scale_service }}-scale {{ up_limit }} \\'
            line: '                       --{{ scale_service }}-scale {{ down_limit }} \'

      - name: scaling overcloud DOWN
        shell: "bash ~/overcloud_deploy.sh"
        register: overcloud_scaling_down
        ignore_errors: yes

      - name: print the last few lines of the output to spot failures
        shell: "tail -n30 overcloud_install.log"

      - fail: msg="Overcloud scailing failed... :("
        when: overcloud_scaling_down.rc != 0

      - name: change list of nodes
        lineinfile:
            dest: "~/overcloud_deploy.sh"
            regexp: '^                       --{{ scale_service }}-scale {{ down_limit }} \\'
            line: '                       --{{ scale_service }}-scale {{ up_limit }} \'

      - name: scaling overcloud UP
        shell: "bash ~/overcloud_deploy.sh"
        register: overcloud_scaling_up
        ignore_errors: yes

      - name: print the last few lines of the output to spot failures
        shell: "tail -n30 overcloud_install.log"

      - fail: msg="Overcloud scailing failed... :("
        when: overcloud_scaling_up.rc != 0