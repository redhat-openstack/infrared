---
- name: Set Iptables rule on openstack nodes
  hosts:
    - controller
    - compute
  become_user: root
  become: yes
  tasks:
    - name: Enable traffic from ODL Controller to nodes
      iptables: chain=INPUT jump=ACCEPT protocol=tcp source="{{ hostvars[item].ansible_ssh_host }}"
      with_items: "{{ groups.odl_controller }}"

    - name: Make openvswitch_t a permissive domain
      command: semanage permissive -a openvswitch_t

- name: Set Iptables rules on opendaylight controller
  hosts:
    - odl_controller
  become_user: root
  become: yes
  tasks:
    - name: Enable traffic from OpenStack nodes to ODL controller
      iptables: chain=INPUT jump=ACCEPT protocol=tcp source="{{ hostvars[item].ansible_ssh_host }}"

      with_items:
        - "{{ groups.compute }}"
        - "{{ groups.controller }}"


- name: Start OpenDaylight distribution
  hosts:
    - odl_controller
  become_user: root
  become: yes
  tasks:
    - name: Setting l3_gateway_mac
      set_fact:
          l3_gateway_mac: "{{ hostvars[inventory_hostname]['ansible_eth0']['macaddress'] }}"
    - name: Add L3 configuration
      lineinfile: dest=/opt/opendaylight/etc/custom.properties regexp="{{ item.regexp }}" line="{{ item.line }}" state=present create=yes
      with_items:
          - { line: 'ovsdb.l3.fwd.enabled=yes',regexp: ovsdb.l3.fwd.enabled }
      notify: restart opendaylight controller server

    - name: Start opendaylight controller server
      service: name=opendaylight state=started
