---
- name: Add host to host list
  hosts: localhost
  gather_facts: no
  vars:
      hypervisor: "{{ provisioner.host }}"
  tasks:
      - name: add hosts to host list
        add_host:
            name: "{{ hypervisor.name }}"
            groups: "{{ hypervisor.groups| join(',') }}"
            node_label: "virthost"
            ansible_ssh_user: "{{ hypervisor.user }}"
            ansible_ssh_host: "{{ hypervisor.address }}"
            ansible_ssh_private_key_file: "{{ hypervisor.key }}"


- name: Setup the virthost
  hosts: virthost
  gather_facts: yes
  pre_tasks:
      - name: update /etc/hosts with VMs details
        lineinfile:
            dest: "/etc/hosts"
            line: "{{ hostvars[item].ansible_ssh_host }}    {{ item }}.redhat.local {{ item }}"
            regexp: ".*{{ item }}$"
            state: present
        with_items: "{{ groups['all'] | difference(['localhost']) | difference(['virthost']) }}"
  roles:
      # FIXME HERE
      # - hardcode versions (as variable)
      # - missing rr_rpm_url, move it to provisioner (virsh only?) as we do need something (ipxe-roms-qemu) from puddle!
      # - teach rhos-release role how to not pin (keep latest = always working, always current)
      # ######
      - role: rhos-release
        rr_rpm_url: "{{ installer.product.rpm }}"
        director_version: "{{ installer.product.version }}"
        director_build: "{{ installer.product.build }}"
        core_version: "{{ installer.product.core.version }}"
        core_build: "{{ installer.product.core.build }}"
        mirror: "{{ installer.mirror | default(omit) }}"
      - {role: provisioner/virsh}

- name: Check SSH connection to newly created VMs
  hosts: all:!localhost:!virthost
  gather_facts: no
  tasks:
      - name: wait for hosts to be reachable
        wait_for:
            port: 22
            host: "{{ ansible_ssh_host }}"
            search_regex: OpenSSH
        delegate_to: virthost
