- name: Perform pre install tasks
  include: "{{ overcloud_pre | default('pre.yml') }}"
  when: install.pre|default('')
  tags:
      - pre

- name: Provision loadbalancer node
  include: loadbalancer.yml
  tags:
      - loadbalancer
      - loadbalancer_setup
  when:
      - "'loadbalancer' in groups"
      - install.deploy|default('')

- name: Introspect our machines
  include: "{{ overcloud_introspect | default('introspect.yml') }}"
  when: install.introspect|default('')
  tags:
      - introspect

- name: Tag our machines with proper flavors
  include: "{{ overcloud_flavors | default('tag.yml') }}"
  when: install.tagging|default('')
  tags:
      - tag

- name: Deploy the Overcloud
  vars:
      templates:
          generate_host_name_template: yes
          storage_add_scale: yes
  include: "{{ overcloud_deploy | default('deploy.yml') }}"
  when:
      - install.deploy|default('')
      - not install.role|default('') or (install.role is defined and install.role.files == 'default')

- name: Deploy the Overcloud with composable roles
  vars:
      deploy_script_template: templates/composable_roles/overcloud_deploy.sh.j2
      templates:
          generate_host_name_template: no
          storage_add_scale: no
  include: "{{ composable_roles | default('composable_roles.yml') }}"
  when:
      - install.deploy|default('')
      - install.role is defined and install.role.files != 'default'
      - install.version|default(undercloud_version) | openstack_release < 12

- name: Deploy the Overcloud with tripleo composable roles
  vars:
      deploy_script_template: templates/tripleo_roles/overcloud_deploy.sh.j2
      templates:
          generate_host_name_template: no
          storage_add_scale: no
  include: "{{ composable_roles | default('tripleo_roles.yml') }}"
  when:
      - install.deploy|default('')
      - install.role is defined
      - install.role.files is defined
      - install.version|default(undercloud_version) | openstack_release > 11

- name: "After overcloud container workarounds (remove it ASAP)"
  include: "docker_after_workaround.yml"
  when:
      - install.deploy|default('')
      - install.version|default(undercloud_version) | openstack_release > 11
      - install.containers|bool
  tags: deploy

- name: Perform post install tasks
  include: "{{ overcloud_post | default('post.yml') }}"
  when: install.post|default('')
  tags:
      - post

- name: collect ansible facts
  hosts: all
  tasks:
    - set_fact:
        ansible_facts_dir: "{{ ansible_user_dir }}/ansible_facts"
        ansible_facts_dir_host: "{{ inventory_dir }}/../../../ansible_facts"
        ansible_facts_filename: "infrared_tripleo-overcloud-install_"

    - name: recreate facts directory on inventory hosts
      file:
        path: "{{ ansible_facts_dir }}"
        state: "{{ item }}"
      with_items:
        - absent
        - directory

    - name: save ansible facts in json file
      copy:
        content: "{{ hostvars[inventory_hostname] | to_nice_json }}"
        dest: "{{ ansible_facts_dir }}/{{ansible_facts_filename}}{{ inventory_hostname }}.json"

    - name: recreate facts directory on localhost
      file:
        path: "{{ ansible_facts_dir_host }}"
        state: "{{ item }}"
      when: inventory_hostname == 'localhost'
      with_items:
        - absent
        - directory

    - name: fetch ansible facts file from inventory hosts
      fetch:
        src: "{{ ansible_facts_dir }}/{{ansible_facts_filename}}{{ inventory_hostname }}.json"
        dest: "{{ ansible_facts_dir_host }}/"
        flat: yes
  when: install.deploy|default('')
  tags: collect_facts