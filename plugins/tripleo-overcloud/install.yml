- name: Delete existing Overcloud
  import_playbook: "{{ delete_overcloud | default('delete.yml') }}"
  vars:
    _run_condition: >-
      {{ (_main_run_condition | bool) and
         (install.delete | default('')) }}
  tags:
      - delete

- name: Perform pre install tasks
  import_playbook: "{{ overcloud_pre | default('pre.yml') }}"
  vars:
    _run_condition: >-
      {{ (_main_run_condition | bool) and
         (install.pre | default('')) }}
  tags:
      - pre

- import_playbook: fetchfiles.yml
  vars:
    _run_condition: >-
      {{ (_main_run_condition | bool) and
         ((install.get('fetchfiles', {}).get('undercloud', {}) != {}) or
          (install.get('fetchfiles', {}).get('overcloud', {}) != {})) }}
  tags:
      - fetchfiles_undercloud
      - fetchfiles_overcloud

- name: Provision loadbalancer node
  import_playbook: loadbalancer.yml
  vars:
    _run_condition: >-
      {{ (_main_run_condition | bool) and
         ('loadbalancer' in groups) and
         (install.deploy | default('')) }}
  tags:
      - loadbalancer
      - loadbalancer_setup

- name: Introspect our machines
  import_playbook: "{{ overcloud_introspect | default('introspect.yml') }}"
  vars:
    _run_condition: >-
      {{ (_main_run_condition | bool) and
         (install.introspect | default('')) }}
  tags:
      - introspect

- name: Check hypervisor state
  hosts: "{{ (_main_run_condition | bool) | ternary('hypervisor', 'none') }}"
  tags: deploy
  any_errors_fatal: true
  tasks:
      - name: include role vbmc check
        include_role:
            name: vbmc
        vars:
            action: "check"
        when:
            - "'hypervisor' in groups"
            - install.deploy|default('')
            - not install.introspect
            - vbmc_host is defined
            - vbmc_host != 'undercloud'

- name: Tag our machines with proper flavors
  import_playbook: "{{ overcloud_flavors | default('tag.yml') }}"
  vars:
    _run_condition: >-
      {{ (_main_run_condition | bool) and
         (install.tagging | default('')) }}
  tags:
      - tag

- name: Deploy the Overcloud
  import_playbook: "{{ overcloud_deploy | default('deploy.yml') }}"
  vars:
    templates:
      generate_host_name_template: yes
      storage_add_scale: yes
    _run_condition: >-
      {{ (_main_run_condition | bool) and
         (install.deploy | default('')) and
         ((not install.role | default('')) or
          ((install.role is defined) and (install.role.files == 'default'))) and
         (not install.splitstack) }}

- name: Deploy the Overcloud with composable roles
  import_playbook: "{{ composable_roles | default('composable_roles.yml') }}"
  vars:
    deploy_script_template: templates/composable_roles/overcloud_deploy.sh.j2
    templates:
      generate_host_name_template: yes
      storage_add_scale: no
    _run_condition: >-
      {{ (_main_run_condition | bool) and
         (install.deploy | default('')) and
         (install.role is defined and install.role.files != 'default') and
         (install.version | default(undercloud_version) | openstack_release < 12) or (not install.tht.roles | bool) and
         (not install.splitstack) }}

- name: Deploy the Overcloud with splitstack
  import_playbook: "{{ splitstack | default('splitstack.yml') }}"
  vars:
    deploy_script_template: templates/splitstack/overcloud_deploy.sh.j2
    templates:
      generate_host_name_template: yes
      storage_add_scale: no
    _run_condition: >-
      {{ (_main_run_condition | bool) and
         (install.deploy | default('')) and
         (install.splitstack | default(False)) }}
  tags:
      - splitstack

#  todo(obaranov) temporary disable tripleo roles cause they do not respect
#  netwrok settings and templates

- name: Deploy the Overcloud with tripleo composable roles
  import_playbook: "{{ composable_roles | default('tripleo_roles.yml') }}"
  vars:
    deploy_script_template: templates/tripleo_roles/overcloud_deploy.sh.j2
    templates:
      generate_host_name_template: yes
      storage_add_scale: no
    _run_condition: >-
      {{ (_main_run_condition | bool) and
         (install.deploy | default('')) and
         (install.role is defined) and
         (install.role.files is defined) and
         (install.version | default(undercloud_version) | openstack_release > 11) and
         (install.tht.roles | bool) and
         (not install.splitstack | bool) }}

- name: Placeholder for container related workarounds - imported playbook needs to be configured
  import_playbook: "docker_after_workaround.yml"
  vars:
    _run_condition: >-
      {{ (_main_run_condition | bool) and
         (install.deploy | default('')) and
         (install.version | default(hostvars[groups['undercloud'][0]].undercloud_version) | openstack_release > 12) and
         (install.containers | bool) }}
  tags: deploy
