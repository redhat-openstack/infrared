- name: Perform pre install tasks
  import_playbook: "{{ overcloud_pre | default('pre.yml') }}"
  when: install.pre|default('')
  tags:
      - pre

- name: Provision loadbalancer node
  import_playbook: loadbalancer.yml
  tags:
      - loadbalancer
      - loadbalancer_setup
  when:
      - "'loadbalancer' in groups"
      - install.deploy|default('')

- name: Introspect our machines
  import_playbook: "{{ overcloud_introspect | default('introspect.yml') }}"
  when: install.introspect|default('')
  tags:
      - introspect

- name: Check hypervisor state
  hosts: hypervisor
  tags: deploy
  any_errors_fatal: true
  tasks:
      - name: include role vbmc check
        include_role:
            name: vbmc
        vars:
            action: "check"
        when:
            - "'hypervisor' in groups"
            - install.deploy|default('')
            - not install.introspect
            - vbmc_host is defined
            - vbmc_host != 'undercloud'

- name: Tag our machines with proper flavors
  import_playbook: "{{ overcloud_flavors | default('tag.yml') }}"
  when: install.tagging|default('')
  tags:
      - tag

- name: Deploy the Overcloud
  vars:
      templates:
          generate_host_name_template: yes
          storage_add_scale: yes
  import_playbook: "{{ overcloud_deploy | default('deploy.yml') }}"
  when:
      - install.deploy|default('')
      - not install.role|default('') or (install.role is defined and install.role.files == 'default')
      - not install.splitstack

- name: Deploy the Overcloud with composable roles
  vars:
      deploy_script_template: templates/composable_roles/overcloud_deploy.sh.j2
      templates:
          generate_host_name_template: no
          storage_add_scale: no
  import_playbook: "{{ composable_roles | default('composable_roles.yml') }}"
  when:
      - install.deploy|default('')
      - install.role is defined and install.role.files != 'default'
      - (install.version|default(undercloud_version) | openstack_release < 12) or install.tht.roles == false
      - not install.splitstack

- name: Deploy the Overcloud with splitstack
  vars:
      deploy_script_template: templates/splitstack/overcloud_deploy.sh.j2
      templates:
          generate_host_name_template: no
          storage_add_scale: no
  include: "{{ splitstack | default('splitstack.yml') }}"
  when:
      - install.deploy|default('')
      - install.splitstack|default(False)
  tags:
      - splitstack

#  todo(obaranov) temporary disable tripleo roles cause they do not respect
#  netwrok settings and templates

- name: Deploy the Overcloud with tripleo composable roles
  vars:
      deploy_script_template: templates/tripleo_roles/overcloud_deploy.sh.j2
      templates:
          generate_host_name_template: no
          storage_add_scale: no
  import_playbook: "{{ composable_roles | default('tripleo_roles.yml') }}"
  when:
      - install.deploy|default('')
      - install.role is defined
      - install.role.files is defined
      - install.version|default(undercloud_version) | openstack_release > 11
      - install.tht.roles == true
      - not install.splitstack

- name: Placeholder for workaround for BZ#1543914 - currently no effect
  import_playbook: "docker_after_workaround.yml"
  when:
      - install.deploy|default('')
      - install.version|default(hostvars[groups['undercloud'][0]].undercloud_version) | openstack_release > 12
      - install.containers|bool
  tags: deploy

- name: Perform post install tasks
  import_playbook: "{{ overcloud_post | default('post.yml') }}"
  when: install.post|default('')
  tags:
      - post
