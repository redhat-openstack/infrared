---
  - name: w/a for bz#1448482
    replace: dest="{{ item.dest }}" regexp="{{ item.regexp }}" replace="{{ item.replace }}" backup=no
    become: true
    with_items:
        - {dest: "/usr/share/openstack-tripleo-heat-templates/environments/docker.yaml", regexp: "OS::TripleO::Compute::NodeUserData: ../docker/firstboot/setup_docker_host.yaml", replace: "OS::TripleO::NodeUserData: ../docker/firstboot/setup_docker_host.yaml" }
        - {dest: "/usr/share/openstack-tripleo-heat-templates/docker/firstboot/setup_docker_host.sh", regexp: "(^/usr/bin/systemctl stop libvirtd.service$)", replace: "\\1\nsetenforce permissive" }

  - name: Create a directory - w/a for bz#1450370
    file:
        path: /home/stack/mariadb-workaround
        state: directory

  - name: "Generate /Dockerfile - w/a for bz#1450370"
    template:
        src: templates/containers/Dockerfile.j2
        dest: "/home/stack/mariadb-workaround/Dockerfile"

  - name: Push openstack-mariadb-docker:workaround image -  w/a for bz#1450370
    shell: |
        docker build --rm -t {{ hostvars[inventory_hostname]['ansible_br_ctlplane']['ipv4']['address'] }}:8787/rhosp12/openstack-mariadb-docker:workaround ~/mariadb-workaround
        docker push {{ hostvars[inventory_hostname]['ansible_br_ctlplane']['ipv4']['address'] }}:8787/rhosp12/openstack-mariadb-docker:workaround
    tags:
       - skip_ansible_lint

  - name: w/a for bz#1452082
    replace: dest=/usr/share/openstack-tripleo-heat-templates/puppet/services/pacemaker/haproxy.yaml regexp="(tripleo.*haproxy.*mysql_clustercheck.*\s)true" replace="\1false"
    become: true

  - name: w/a for bz#1455348
    shell: sed -i '/nf_conntrack_proto_sctp/d' /usr/share/openstack-tripleo-heat-templates/puppet/services/kernel.yaml
    become: true
    tags:
       - skip_ansible_lint

  - name: w/a for bz#1458044
    shell: |
       sudo yum downgrade -y http://download-node-02.eng.bos.redhat.com/rcm-guest/puddles/OpenStack/12.0-RHEL-7/passed_phase1/RH7-RHOS-12.0/x86_64/os/Packages/python-novaclient-7.1.0-0.20170206165048.f6e0128.el7.noarch.rpm
       sudo systemctl restart openstack-heat-engine
    tags:
       - skip_ansible_lint
