- block:
      - name: append the ceph storage template line to the base overcloud deploy script
        lineinfile:
            dest: "~/overcloud_deploy.sh"
            line: '--block-storage-scale  {{ storage_nodes }} \'
        when:
            - "templates.storage_add_scale | default(True)"
      - name: append the swift storage template line to the base overcloud deploy script
        lineinfile:
            dest: "~/overcloud_deploy.sh"
            line: '--block-storage-flavor {{ ("cinder" in existing_flavors.stdout_lines and not install.specific.node.ids) | ternary("cinder", "baremetal") }} \'
        when:
            - "templates.storage_add_scale|default(True)"

  when:
      - not install.storage.external
  vars:
      storage_nodes: "{{ (install.storage.nodes|default(0)) or (groups['cinder']|default([])|length) or 1 }}"

- block:
      - name: Copy storage configuration file to the remote
        copy:
            src: "vars/storage/config/{{ install.storage.config }}.yml"
            dest: "{{ template_base }}/{{ install.storage.config }}.yaml"

      - name: Append the storage configuration line to the base overcloud deploy script
        lineinfile:
            dest: "~/overcloud_deploy.sh"
            line: '-e {{ template_base }}/{{ install.storage.config }}.yaml \'
  when: install.storage.config != 'internal'
