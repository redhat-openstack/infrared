- block:
      - name: Install NFS packages
        yum:
            name: nfs-utils
            state: present

      - name: Start and enable NFS services
        systemd:
            name: "{{ item }}"
            state: started
            enabled: yes
        with_items:
            - nfs-server
            - rpcbind

      - name: Create NFS share
        file:
            path: /nfsfileshare
            state: directory
            mode: '777'
            group: nfsnobody
            owner: nfsnobody

      - name: Configure exports file
        lineinfile:
            path: /etc/exports
            line: '/nfsfileshare *(rw,sync,no_root_squash)'

      - name: Export NFS share to the server
        command: "exportfs -r"

      - name: Set iptables rules
        iptables:
            chain: INPUT
            source: 192.168.24.0/24
            jump: ACCEPT
            destination_port: 2049
            protocol: "{{ item }}"
        with_items:
            - tcp
            - udp

      - name: Put SELinux in permissive mode
        selinux:
            policy: targeted
            state: permissive
  become: true
  when:
      - install.local.nfs.server | default(False)
