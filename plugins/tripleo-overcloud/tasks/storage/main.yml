- name: try to discover storage storage
  include_tasks: discover_backend.yml

- name: get ceph_disks
  vars:
      storage_group: "{{ groups[storage_backend] | list }}"
  include_tasks: disks_from_instackenv.yml
  when:
      - storage_backend in groups
      - storage_backend in ['swift', 'ceph']
      - "not install.storage.external"
      - "not install.splitstack"

# If user provided storage templates, nothing to do here :)
- include_tasks: "{{ storage_backend }}.yml"
  when:
    - storage_backend|default('')

- block:
    - name: Copy storage configuration file to the remote
      copy:
        src: "{{ install.storage.config.file }}"
        dest: "{{ template_base }}"

    - name: Append the storage configuration line to the base overcloud deploy script
      lineinfile:
        dest: "~/overcloud_deploy.sh"
        line: '-e {{ template_base }}/{{ install.storage.config.file | basename }} \'
  when: install.storage.config.file is defined