# this shell supports OSP7 and above.
- name: get provision subnet(s) - multiple in spine/leaf scenario
  shell: |
      source ~/stackrc
      subnets_id=$(openstack network show {{ uc_provision_net|default('ctlplane')  }} | grep -owP 'subnets.*\|\s\K.*[^\|]+' |tr -d ',')
      for subnet in $subnets_id; do 
           neutron subnet-show $subnet | grep -owP 'cidr.*\|\s\K.*[^\|]+' | tr -d ' '
      done
  register: subnets_cidr

- name: get network list from hypervisor
  delegate_to: hypervisor
  virt_net:
      command: list_nets
  register: virsh_networks

- name: get assigned ip addresses for the networks
  delegate_to: hypervisor
  shell: |
      echo $(/sbin/ip -o addr list {{ item }} | awk '{print $4}')
  register: virsh_networks_ips
  with_items: "{{ virsh_networks.list_nets }}"
  tags: skip_ansible_lint

- name: Initialize provison_virsh_network_name fact to empty
  set_fact:
      provison_virsh_network_name: ""

- name: save network names
  set_fact:
      provison_virsh_network_name: "{{ provison_virsh_network_name }} {{ item.item }}"
  with_items: "{{ virsh_networks_ips.results }}"
  when: item.stdout |ipaddr('subnet') in subnets_cidr.stdout_lines
