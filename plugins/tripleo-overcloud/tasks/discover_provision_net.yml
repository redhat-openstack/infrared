# this shell supports OSP7 and above.
- name: get provision subnet(s) - multiple in spine/leaf scenario
  shell: |
      source ~/stackrc
      openstack network show {{ uc_provision_net|default('ctlplane')  }} | grep -owP 'subnets.*\|\s\K.*[^\|]+' |tr -d ','
  register: ctlplane_subnets

- name: get ctlplane subnets prefixes
  shell: |
    source ~/stackrc
    neutron subnet-show {{ item }} | grep -owP 'cidr.*\|\s\K.*[^\|]+' | tr -d ' '
  with_items: "{{ ctlplane_subnets.stdout.split(',') }}"
  register: subnet_prefixes

- name: get network list from hypervisor
  delegate_to: hypervisor
  virt_net:
      command: list_nets
  register: virsh_networks

- name: get assigned ip addresses for the networks
  delegate_to: hypervisor
  shell: |
      echo $(/sbin/ip -o addr list {{ item }} | awk '{print $4}')
  register: virsh_networks_ips
  with_items: "{{ virsh_networks.list_nets }}"
  tags: skip_ansible_lint

- name: Initialize provison_virsh_network_name fact to empty
  set_fact:
      provison_virsh_network_name: ""

- name: save network names
  set_fact:
      provison_virsh_network_name: "{{ provison_virsh_network_name }} {{ item.item }}"
  with_items: "{{ virsh_networks_ips.results }}"
  when: item.stdout |ipaddr('subnet') in subnet_prefixes.results|map(attribute='stdout')|list
