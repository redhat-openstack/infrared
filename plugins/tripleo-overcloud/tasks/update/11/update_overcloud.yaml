---
- include_vars: vars/updates/update_11.yml

- name: create update script {{ overcloud_update_script }}
  copy:
    dest: "{{ overcloud_update_script }}"
    mode: 0755
    content: |
        yes ""| tail -n +1 | openstack overcloud update stack -i overcloud

- name: execute {{ CONNECTIVITY_SCRIPT }} remotely
  shell: |
    bash {{ CONNECTIVITY_SCRIPT_FILE }} &
  register: connectivity_test
  ignore_errors: True
  async: 21660
  poll: 0

- name: run overcloud-update script
  shell: |
    source ~/stackrc && bash {{ overcloud_update_script }}
  register: overcloud_update
  ignore_errors: True

- name: debug variable overcloud_update
  debug:
    msg: "{{ overcloud_update }}"
  when: overcloud_update is defined

- name: print overcloud failures
  shell: |
    source ~/stackrc ;
    openstack stack failures list overcloud
  when: overcloud_update.rc != 0

- name: failed to update overcloud
  fail:
    msg: Failed to update overcloud
  when:
    - overcloud_update.rc != 0
    - "'update finished with status COMPLETE' not in overcloud_update.stdout_lines"

- name: successfull overcloud update
  debug:
    msg: 'Successfully updated overcloud'
  when:
    - overcloud_update.rc == 0
    - "'update finished with status COMPLETE' in overcloud_update.stdout_lines"
  ignore_errors: True

- name: summarize connectivity
  include: tasks/update/11/assert_connectivity_result.yaml
