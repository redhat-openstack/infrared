---
- name: Register ceph nodes count
  set_fact:
      ceph_count: "{{ groups['ceph'] | length }}"

- block:
    - name: Ceph osd set noout on {{ node_name }}
      shell: "ssh -q heat-admin@{{ hostvars[node_name].ansible_ssh_host }} 'sudo ceph osd set noout'"

    - name: Ceph osd set norebalance {{ node_name }}
      shell: "ssh -q heat-admin@{{ hostvars[node_name].ansible_ssh_host }} 'sudo ceph osd set norebalance'"

  when: ceph_count | int > 1

- name: Reboot Node
  include: 'reboot_node.yml'
  tags: ceph_reboot

- block:
    - name: Wait for OSDs on {{ node_name }} to come back online
      shell: "ssh -q heat-admin@{{ hostvars[node_name].ansible_ssh_host }} sudo ceph pg stat"
      register: active_osd
      until: active_osd.stdout.find("active+clean") > -1
      retries: 30
      delay: 5

    - name: Ceph osd unset noout {{ node_name }}
      shell: "ssh -q heat-admin@{{ hostvars[node_name].ansible_ssh_host }} 'sudo ceph osd unset noout'"

    - name: Ceph osd unset norebalance {{ node_name }}
      shell: "ssh -q heat-admin@{{ hostvars[node_name].ansible_ssh_host }} 'sudo ceph osd unset norebalance'"

    - name: Make sure that cluster is in healthy state
      shell: "ssh -q heat-admin@{{ hostvars[node_name].ansible_ssh_host }} sudo ceph health"
      register: ceph_health
      until: ceph_health.stdout.find("HEALTH_OK") > -1
      retries: 30
      delay: 5

  when: ceph_count | int > 1

- name: Packages Check
  include: 'packages_check.yml'
