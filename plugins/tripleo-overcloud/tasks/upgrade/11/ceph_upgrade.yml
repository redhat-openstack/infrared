---
- name: Register ceph nodes count
  set_fact:
      ceph_count: "{{ groups['ceph'] | length }}"

- block:
    - name: Ceph osd set noout on {{ node_name }}
      become: true
      shell: "ceph osd set noout"
      delegate_to: "{{ node_name }}"

    - name: Ceph osd set norebalance {{ node_name }}
      become: true
      shell: "ceph osd set norebalance"
      delegate_to: "{{ node_name }}"

  when: ceph_count | int > 2

- name: Reboot Node
  include: 'reboot_node.yml'
  tags: ceph_reboot

- block:
    - name: Wait for OSDs on {{ node_name }} to come back online
      become: true
      shell: "ceph pg stat"
      register: active_osd
      until: active_osd.stdout.find("active+clean") > -1
      retries: 30
      delay: 5
      delegate_to: "{{ node_name }}"

    - name: Ceph osd unset noout {{ node_name }}
      become: true
      shell: "ceph osd unset noout"
      delegate_to: "{{ node_name }}"

    - name: Ceph osd unset norebalance {{ node_name }}
      become: true
      shell: "ceph osd unset norebalance"
      delegate_to: "{{ node_name }}"

    - name: Make sure that cluster is in healthy state
      become: true
      shell: "ceph health"
      register: ceph_health
      until: ceph_health.stdout.find("HEALTH_OK") > -1
      retries: 30
      delay: 5
      delegate_to: "{{ node_name }}"

  when: ceph_count | int > 2

- name: Packages Check
  include: 'packages_check.yml'
