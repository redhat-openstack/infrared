---
- name: Register roles_data file location
  shell: "grep '\\-r\\ \\|\\-\\-roles' {{ overcloud_upgrade_script }} | awk {'print $2'}"
  register: roles

- name: Copy OSP10 roles_data.yaml
  copy:
      src: "{{ roles.stdout }}"
      dest: "~/roles_data.yaml.old"
      remote_src: true

- name: Add disable_upgrade_deployment to roles
  replace:
      dest: '{{ roles.stdout }}'
      regexp: '^(- name: (Compute|ObjectStorage).*$)'
      replace: '\1\n  disable_upgrade_deployment: True'

- name: Clear removed service for roles_data.yaml file
  lineinfile:
      dest: '{{ roles.stdout }}'
      regexp: "{{ item }}"
      state: absent
  with_items:
      - 'OS::TripleO::Services::Core'
      - 'OS::TripleO::Services::VipHosts'
      - 'OS::TripleO::Services::GlanceRegistry'

## Note - I'm trying to tie the new services introduced in Ocata
## to already existing services from OSP10. In case of the new
## unrelated services they are being placed on the Controller role.
## Since they new services have not been used for the initial deployment
## most of them would probably remain undeployed but it's best to keep the
## roles_data.yaml file up to date with the introduced changes.

- name: Add base services introduced in Ocata
  replace:
      dest: '{{ roles.stdout }}'
      regexp: '(- OS::TripleO::Services::Timezone)'
      replace: "{{ item }}"
  with_items:
      - '\1\n    - OS::TripleO::Services::Sshd'
      - '\1\n    - OS::TripleO::Services::AuditD'
      - '\1\n    - OS::TripleO::Services::Collectd'
      - '\1\n    - OS::TripleO::Services::MySQLClient'

- name: Add Neutron ML2 services introduced in Ocata
  replace:
      dest: '{{ roles.stdout }}'
      regexp: '(- OS::TripleO::Services::NeutronCorePlugin)'
      replace: "{{ item }}"
  with_items:
      - '\1\n    - OS::TripleO::Services::NeutronML2FujitsuCfab'
      - '\1\n    - OS::TripleO::Services::NeutronML2FujitsuFossw'

- name: Add CinderHPELeftHandISCSI service introduced in Ocata
  replace:
      dest: '{{ roles.stdout }}'
      regexp: '(- OS::TripleO::Services::CinderVolume)'
      replace: '\1\n    - OS::TripleO::Services::CinderHPELeftHandISCSI'

- name: Add Nova services introduced in Ocata
  replace:
      dest: '{{ roles.stdout }}'
      regexp: '(- OS::TripleO::Services::NovaApi)'
      replace: "{{ item }}"
  with_items:
      - '\1\n    - OS::TripleO::Services::NovaPlacement'
      - '\1\n    - OS::TripleO::Services::Ec2Api'

- name: Add Ceph services introduced in Ocata
  replace:
      dest: '{{ roles.stdout }}'
      regexp: '(- OS::TripleO::Services::CephMon)'
      replace: "{{ item }}"
  with_items:
      - '\1\n    - OS::TripleO::Services::CephMds'
      - '\1\n    - OS::TripleO::Services::CephRbdMirror'

- name: Add Telemetry services introduced in Ocata
  replace:
      dest: '{{ roles.stdout }}'
      regexp: '(- OS::TripleO::Services::CeilometerApi)'
      replace: '\1\n    - OS::TripleO::Services::PankoApi'

- name: Add the rest of the new services introduced in Ocata to Controller role'
  replace:
      dest: '{{ roles.stdout }}'
      regexp: '^(- name: Controller\n.*\n.*ServicesDefault.*)'
      replace: "{{ item }}"
  with_items:
      - '\1\n    - OS::TripleO::Services::Congress'
      - '\1\n    - OS::TripleO::Services::BarbicanApi'
      - '\1\n    - OS::TripleO::Services::Tacker'
      - '\1\n    - OS::TripleO::Services::Zaqar'
      - '\1\n    - OS::TripleO::Services::OVNDBs'
      - '\1\n    - OS::TripleO::Services::Etcd'
      - '\1\n    - OS::TripleO::Services::OctaviaApi'
      - '\1\n    - OS::TripleO::Services::OctaviaHealthManager'
      - '\1\n    - OS::TripleO::Services::OctaviaHousekeeping'
      - '\1\n    - OS::TripleO::Services::OctaviaWorker'
