---
## nova live-migration could silently fail when it runs for the 1st time so we try it twice
- name: List compute nodes
  shell: |
      source {{ overcloud_rc }}
      openstack hypervisor list -f json
  register: hypervisors_result
  until: hypervisors_result|succeeded
  retries: 30
  delay: 5

- name: Get instances running on "{{ node_name }}"
  shell: |
      source {{ overcloud_rc }}
      openstack server list --host "{{ hostvars[node_name].ansible_fqdn }}" --status active -f json
  register: instances_result
  until: instances_result|succeeded
  retries: 30
  delay: 5

- name: Migrate instances from {{ node_name }}
  shell: "source {{ overcloud_rc }} ;nova live-migration {{ instance_name }} {{ hypervisors | difference(hostvars[node_name].ansible_fqdn) | random }}"
  with_items: "{{ instances }}"
  register: instance_mig
  until: instance_mig|succeeded
  retries: 10
  delay: 120
  loop_control:
      loop_var: instance_name
  vars:
      hypervisors: "{{ hypervisors_result.stdout|from_json|map(attribute='Hypervisor Hostname')|list }}"
      instances: "{{ instances_result.stdout|from_json|map(attribute='Name')|list }}"

- name: Wait for instances to be in ACTIVE state
  shell: |
      source {{ overcloud_rc }}
      openstack server show {{ item }} -f json
  with_items: "{{ instances }}"
  register: running_instances
  until: (running_instances.stdout|from_json).status.find("ACTIVE") > -1
  retries: 30
  delay: 5
  vars:
      instances: "{{ instances_result.stdout|from_json|map(attribute='Name')|list }}"

- name: Check if the compute node is quiesced
  shell: |
      source {{ overcloud_rc }}
      openstack server list --host {{ hostvars[node_name].ansible_fqdn }} --status active -f json | wc -l
  register: empty_compute
  until: empty_compute|succeeded
  retries: 30
  delay: 5

- block:
    - name: Migrate instances from {{ node_name }}
      shell: "source {{ overcloud_rc }} ;nova live-migration {{ instance_name }} {{ hypervisors | difference(hostvars[node_name].ansible_fqdn) | random }}"
      with_items: "{{ instances }}"
      register: instance_mig
      until: instance_mig|succeeded
      retries: 10
      delay: 120
      loop_control:
          loop_var: instance_name
      vars:
          hypervisors: "{{ hypervisors_result.stdout|from_json|map(attribute='Hypervisor Hostname')|list }}"
          instances: "{{ instances_result.stdout|from_json|map(attribute='Name')|list }}"

    - name: Wait for instances to be in ACTIVE state
      shell: |
          source {{ overcloud_rc }}
          openstack server show {{ item }} -f json
      with_items: "{{ instances }}"
      register: running_instances
      until: (running_instances.stdout|from_json).status.find("ACTIVE") > -1
      retries: 30
      delay: 5
      vars:
          instances: "{{ instances_result.stdout|from_json|map(attribute='Name')|list }}"

    - name: Check if the compute node is quiesced
      shell: |
          source {{ overcloud_rc }}
          openstack server list --host {{ hostvars[node_name].ansible_fqdn }} --status active -f json | wc -l
      register: compute_instances

    - fail:
          msg: "Instance live migration failed"
      when: compute_instances.stdout | int != 0
  when: (empty_compute.stdout|default('0')) | int != 0