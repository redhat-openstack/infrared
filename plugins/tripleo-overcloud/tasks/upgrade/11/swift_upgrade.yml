---
- name: Upgrade swift node
  shell: |
      source {{ undercloud_rc }}
      upgrade-non-controller.sh --upgrade {{ swiftnode }} &> {{ swiftnode }}-upgrade.log

- name: Reboot {{ swiftnode }}
  shell: "sleep 2; ssh -q heat-admin@{{ hostvars[swiftnode].ansible_ssh_host }} sudo shutdown -r now"
  async: 1
  poll: 0
  ignore_errors: true
  tags: swift_reboot

- name: Wait for {{ swiftnode }} to go down
  shell: "ping -c1 {{ hostvars[swiftnode].ansible_ssh_host }}"
  ignore_errors: true
  register: swiftdown
  until: swiftdown.rc != 0
  retries: 30
  delay: 5
  tags: swift_reboot

- name: Wait for the swift services to come back up
  shell: "ssh -q heat-admin@{{ hostvars[swiftnode].ansible_ssh_host }} 'systemctl show {{ item }} --property ActiveState'"
  register: swift_svc
  until: swift_svc.stdout.find("ActiveState=active") > -1
  retries: 30
  delay: 5
  with_items:
      - 'openstack-swift-account-auditor.service'
      - 'openstack-swift-account-reaper.service'
      - 'openstack-swift-account-replicator.service'
      - 'openstack-swift-account.service'
      - 'openstack-swift-container-auditor.service'
      - 'openstack-swift-container-replicator.service'
      - 'openstack-swift-container-updater.service'
      - 'openstack-swift-container.service'
      - 'openstack-swift-object-auditor.service'
      - 'openstack-swift-object-replicator.service'
      - 'openstack-swift-object-updater.service'
      - 'openstack-swift-object.service'

## We should add some additional checks here to make sure that the nodes have correctly rejoined the cluster ##

- name: Check if there any remaining updates on {{ swiftnode }}
  shell: "ssh -q heat-admin@{{ hostvars[swiftnode].ansible_ssh_host }} yum check-update --quiet | wc -l"
  register: yumupdate

- fail:
      msg: "There are remaining packages to be updated on {{ swiftnode }} or yum didn't run successfully"
  when: yumupdate.stdout != '0'
