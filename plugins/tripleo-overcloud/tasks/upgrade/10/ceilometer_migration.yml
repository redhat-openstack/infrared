---
- name: Uploading Ceilometer Patch
  copy:
    src: "{{ plugin_dir }}/files/upgrade/10/ceilometer_patch1"
    dest: "{{ temp_dir }}/ceilometer_patch1"

- name: Checking if patch is already applied
  become: true
  become_user: root
  become_method: sudo
  shell: "patch -N -d /usr/share/openstack-tripleo-heat-templates -p1 --dry-run --silent  < {{ temp_dir }}/ceilometer_patch1"
  ignore_errors: yes
  register: check_ceilometer_patch

- name: Applying patch
  become: true
  become_user: root
  become_method: sudo
  patch:
    src: "{{ temp_dir }}/ceilometer_patch1"
    remote_src: true
    basedir: /usr/share/openstack-tripleo-heat-templates
    strip: 1
    backup: yes
  when: check_ceilometer_patch|succeeded

- name: Create Ceilometer migration base script
  copy:
    src: "{{ overcloud_deploy_script }}"
    dest: "{{ ceilometer_migration_script }}"
    mode: 0755
    remote_src: true

- name: Append params to Ceilometer migration script
  lineinfile:
    dest: "{{ ceilometer_migration_script }}"
    insertbefore: '^--log-file.*'
    line: '-e /usr/share/openstack-tripleo-heat-templates/environments/major-upgrade-ceilometer-wsgi-mitaka-newton.yaml \'

- name: Change log file name of Ceilometer migration script
  lineinfile:
    dest: "{{ ceilometer_migration_script }}"
    regexp: '^--log-file.*'
    line: '--log-file ceilometer-migration.log'

- name: Print Ceilometer migration command
  command: "cat {{ ceilometer_migration_script }}"

- name: Executing Ceilometer migration command
  shell: |
      source ~/stackrc
      bash {{ ceilometer_migration_script }} &> ceilometer-migration2.log

- name: Reverse Ceilometer Patch
  become: true
  become_user: root
  become_method: sudo
  shell: "patch -R -d /usr/share/openstack-tripleo-heat-templates -p1 < {{ temp_dir }}/ceilometer_patch1"
  when: check_ceilometer_patch.rc == 0