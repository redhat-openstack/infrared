---
- name: Setting temp_dir
  file:
      path: "{{ temp_dir }}"
      state: directory

- name: SSL Config
  include: "ssl.yml"
  tags:
      - upgrade
      - upgrade_ssl

- name: Pre-Upgrade Ceilometer migration
  include: "ceilometer_migration.yml"
  tags:
      - upgrade
      - upgrade_ceilometer
  vars:
      ceilometer_migration_script: "~/ceilometer_migration.sh"

- name: Overcloud Upgrade Init
  include: "upgrade_init.yml"
  tags:
      - upgrade
      - upgrade_init
  vars:
      upgrade_init_script: "~/upgrade_init.sh"

- name: Object Storage Upgrade
  shell : |
      source {{ undercloud_rc }}
      upgrade-non-controller.sh --upgrade {{ item }} &>> swift-upgrade.log
  tags:
    - upgrade
    - upgrade_object_storage
  with_items: "{{ groups.swift|default([]) }}"

- name: Controller And Block Storage Upgrade
  include: "controller_upgrade.yml"
  tags:
      - upgrade
      - upgrade_controller
  vars:
      controller_upgrade_script: "~/controller_upgrade.sh"

- pip:
      name: "{{ item.key }}"
      version: "{{ item.value }}"
      virtualenv: "{{ path_venv }}"
  with_dict:
      setuptools: "17.0"
      pytz: "2016.4"
      shade: "1.19.0"
      requests: "2.11.1"
      pip: "8.1"

- name: Grab auth data from {{ overcloud_rc }} file and publish it as YAML
  shell: |
      source {{ overcloud_rc }}
      echo "
      auth_url: $OS_AUTH_URL
      username: $OS_USERNAME
      password: $OS_PASSWORD
      project_name: ${OS_PROJECT_NAME:-$OS_TENANT_NAME}
      "
      if [ -n "$OS_PROJECT_DOMAIN_NAME" ]; then
          echo "project_domain_name: $OS_PROJECT_DOMAIN_NAME"
      fi
      if [ -n "$OS_USER_DOMAIN_NAME" ]; then
          echo "user_domain_name: $OS_USER_DOMAIN_NAME"
      fi
  register: creds

- name: Compute Upgrade
  include: compute_upgrade.yml
  with_items: "{{ groups.compute|default([]) }}"
  loop_control:
      loop_var: node_name
  tags:
    - upgrade
    - upgrade_compute

- name: Ceph Upgrade
  shell : |
      source {{ undercloud_rc }}
      upgrade-non-controller.sh --upgrade {{ item }} &>> ceph-upgrade.log
  tags:
    - upgrade
    - upgrade_ceph
  with_items: "{{ groups.ceph|default([]) }}"

- name: Convergence
  include: "convergence.yml"
  tags:
      - upgrade
      - upgrade_convergence
  vars:
      convergence_script: "~/convergence.sh"

- name: Overcloud Post-Upgrade Aodh migration
  include: "aodh_migration.yml"
  tags:
      - upgrade
      - upgrade_aodh
  vars:
      aodh_migration_script: "~/aodh_migration.sh"

- name: Deleting temp folder
  file:
      path: "{{ temp_dir }}"
      state: absent
