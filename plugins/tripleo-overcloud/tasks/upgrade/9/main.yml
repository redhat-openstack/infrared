---
- name: SSL Config
  include: "ssl.yml"
  tags:
      - upgrade
      - upgrade_ssl

- name: run upgrade steps
  include: "../common/upgrade_step.yml"
  with_items:
    - step: "AODH installation"
      script: "~/aodh_installation.sh"
      environment_file: /usr/share/openstack-tripleo-heat-templates/environments/major-upgrade-aodh.yaml
    - step: "Keystone pre-upgrade"
      script: "~/keystone_upgrade.sh"
      environment_file: /usr/share/openstack-tripleo-heat-templates/environments/major-upgrade-keystone-liberty-mitaka.yaml
    - step: "Upgrade init"
      script: "~/upgrade_init.sh"
      environment_file: /usr/share/openstack-tripleo-heat-templates/environments/major-upgrade-pacemaker-init.yaml

- name: Object Storage Upgrade
  shell : |
      source {{ undercloud_rc }}
      upgrade-non-controller.sh --upgrade {{ item }} &>> swift-upgrade.log
  tags:
    - upgrade
    - upgrade_object_storage
  with_items: "{{ groups.swift|default([]) }}"

- name: Controller upgrade
  include: "../common/upgrade_step.yml"
  with_items:
    - step: "Controller upgrade"
      script: "~/controller_upgrade.sh"
      environment_file: /usr/share/openstack-tripleo-heat-templates/environments/major-upgrade-pacemaker.yaml

- name: Ceph Upgrade
  shell : |
      source {{ undercloud_rc }}
      upgrade-non-controller.sh --upgrade {{ item }} &>> ceph-upgrade.log
  tags:
    - upgrade
    - upgrade_ceph
  with_items: "{{ groups.ceph|default([]) }}"

- name: Compute Upgrade
  shell : |
      source {{ undercloud_rc }}
      upgrade-non-controller.sh --upgrade {{ item }} &>> compute-upgrade.log
  tags:
    - upgrade
    - upgrade_compute
  with_items: "{{ groups.compute|default([]) }}"

- name: Upgrade convergence
  include: "../common/upgrade_step.yml"
  with_items:
    - step: "Upgrade convergence"
      script: "~/convergence.sh"
      environment_file: /usr/share/openstack-tripleo-heat-templates/environments/major-upgrade-pacemaker-converge.yaml
