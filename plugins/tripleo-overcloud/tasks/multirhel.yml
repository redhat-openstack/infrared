# this file will set up files required by computeRHEL8 tripleo role

- name: "Ensure {{ template_base }}/roles/ directory exists"
  file:
    path: "{{ template_base }}/roles/"
    state: directory

- name: Create ComputeRHEL8.yaml role file from an existing Compute.yaml one
  copy:
    remote_src: true
    src: /usr/share/openstack-tripleo-heat-templates/roles/Compute.yaml
    dest: "{{ template_base }}/roles/ComputeRHEL8.yaml"

- name: Modify the "Role" name inside ComputeRHEL8.yaml
  lineinfile:
    backrefs: true
    dest: "{{ template_base }}/roles/ComputeRHEL8.yaml"
    regexp: '(.*)name: Compute'
    line: '\1name: ComputeRHEL8'

- name: "Merge {{ install.heat.templates.basedir }}/roles/Controller.yaml,{{ install.heat.templates.basedir }}/roles/Compute.yaml with ComputeRHEL8.yaml as {{ template_base }}/roles/roles_data_multirhel.yaml"
  shell: |
    cat {{ template_base }}/roles/ComputeRHEL8.yaml > {{ template_base }}/roles/roles_data_multirhel.yaml
    cat {{ install.heat.templates.basedir }}/roles/Controller.yaml {{ install.heat.templates.basedir }}/roles/Compute.yaml>> {{ template_base }}/roles/roles_data_multirhel.yaml

- name: "Create ComputeRHEL8.yaml file"
  template:
    src: ComputeRHEL8.yaml.j2
    dest: "{{ template_base }}/ComputeRHEL8.yaml"

- name: Append "-e {{ template_base }}/ComputeRHEL8.yaml" line to ~/overcloud_deploy.sh
  lineinfile:
    dest: "~/overcloud_deploy.sh"
    line: '-e {{ template_base }}/ComputeRHEL8.yaml \'
    insertbefore: "^--log-file.*"