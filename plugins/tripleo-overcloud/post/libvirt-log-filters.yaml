---
# Enable libvirt log filters (and redirect the output to a file). This
# is useful to understand interactions between libvirt and QEMU, i.e. it
# lets us see what exact QMP (QEMU Monitor Protocol) commands that
# libvirt is sending to QEMU.  Helpful in various scenarios -- like
# examining live migration interactions, debugging, etc.

- name: Set libvirt debug log filters and log output file
  hosts: compute:!unused
  become: yes
  tags: enable_libvirt_log_filters
  any_errors_fatal: false
  gather_facts: no

  vars:
      log_owner: "root"
      libvirtd_config: "/etc/libvirt/libvirtd.conf"
      libvirtd_log_dir: "/var/log/libvirt/libvirtd"
      libvirtd_log: "libvirtd.log"

  tasks:
    - name: Ensure the libvirt log directory exists
      file:
        path: "{{ libvirtd_log_dir }}"
        state: directory
        owner: "{{ log_owner }}"
        group: "{{ log_owner }}"
        mode: 0600

    - name: Set libvirt debug log filters and log output file
      lineinfile:
        path: "{{ libvirtd_config }}"
        line: "{{ item }}"
        owner: "{{ log_owner }}"
        group: "{{ log_owner }}"
        mode: 0600
        create: yes
      with_items:
        - 'log_filters="1:libvirt 1:qemu 1:conf 1:security 3:event 3:json 3:file 3:object 1:util 1:cpu"'
        - 'log_outputs="1:file:{{ libvirtd_log_dir }}/{{ libvirtd_log }}"'
