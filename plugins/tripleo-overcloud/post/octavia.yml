---
# Part of the official Octavia deployment includes manual steps to run after deployment is done
- name: Octavia post deployment tasks
  hosts: undercloud
  become: true
  any_errors_fatal: true
  gather_facts: no
  tasks:
    - name: Install openstack-octavia-diskimage-create
      yum:
          name: openstack-octavia-diskimage-create
          state: present

    - name: Download RHEL base image for building Octavia Amphora image
      get_url:
          url: "{{ install.octavia.image.url }}"
          dest: "/home/stack/rhel-7.qcow2"
          force: yes
          validate_certs: no

    - name: install libguestfs-tools to get virt-customize
      become: yes
      package:
          name: libguestfs-tools
          state: present

    - name: Install & run rhos-release in RHEL base image
      command: "{{ item }}"
      with_items:
        - "virt-copy-in -a /home/stack/rhel-7.qcow2 --selinux-relabel --run-command 'yum localinstall -y https://url.corp.redhat.com/rhos-release-latest-rpm'"
        - "virt-copy-in -a /home/stack/rhel-7.qcow2 --selinux-relabel --run-command 'rhos-release {{ install.version }}'"

    - name: Create Amphora image
      environment:
          DIB_LOCAL_IMAGE: '/home/stack/rhel-7.qcow2'
      command: octavia-diskimage-create.sh -i rhel

    - name: Upload Amphora image to glance
      shell: |
          source ~/overcloudrc
          sleep 99999999999999999999999999999999999999999999
          glance image-create --name octavia-amphora --disk-format qcow2 --container-format bare --tags amphora --file <image_file>

    - name: Copy octavia-post-deploy script to the undercloud
      copy:
          src: "files/octavia-post-deploy.sh"
          dest: ~/octavia-post-deploy.sh
          mode: 0755

    - name: Execute octavia-post-deploy script
      shell: bash ~/octavia-post-deploy.sh &> octavia-post-deploy.log
