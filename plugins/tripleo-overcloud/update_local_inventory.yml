---
- name: Update Inventory from OSPD
  hosts: undercloud
  gather_facts: yes
  any_errors_fatal: true
  vars:
      user: heat-admin
      # The var "private_key" is used outside this scope and cannot be overridden
      overcloud_pkey: "{{ inventory_dir }}/id_rsa_overcloud"
  tasks:
      - name: fetch the private key file from the undercloud
        fetch:
            src: "~/.ssh/id_rsa"
            dest: "{{ overcloud_pkey }}"
            flat: yes

      - name: update file permissions
        delegate_to: localhost
        become: no
        file:
            path: "{{ overcloud_pkey }}"
            mode: 0600

- name: Update the inventory file
  hosts: localhost
  gather_facts: no
  roles:
      - role: inventory-update
        omit_groups: [ 'ovb' ]
        inventory_file_name: 'hosts-install'
  tasks:
    - name: refresh dynamic inventory
      meta: refresh_inventory
