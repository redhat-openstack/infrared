- name: Deploy the Overcloud
  hosts: undercloud
  gather_facts: yes
  any_errors_fatal: true
  tags: fetch_deploy_input
  vars:
      deployer_input: "{{ ansible_user_dir }}/tempest-deployer-input.conf"
  tasks:

      - name: "Enable console logging: https://review.openstack.org/#/c/387445/"
        ini_file:
            dest: "{{ deployer_input }}"
            section: "{{ item.section }}"
            option: "{{ item.option }}"
            value: "{{ item.value }}"
        when: "{{ item.condition | default(True) }}"
        with_items:
            # Workaround RHBZ#1357579 - non-default region=regionOne
            # - section: identity
            #   option: region
            #   value: regionOne
            # Enable console logging: https://review.openstack.org/#/c/387445/
            - section: compute-feature-enabled
              option: console_output
              value: true
            # Disable encrypted volume tests rhbz#1383377
            - section: compute-feature-enabled
              option: attach_encrypted_volume
              value: false
            # Configure storage protocol when ceph: https://bugs.launchpad.net/tripleo/+bug/1634499
            - section: volume
              option: storage_protocol
              value: ceph
              condition: "{{ installer.storage.backend.startswith('ceph') }}"
            # Configure nfs protocol
            - section: volume
              option: storage_protocol
              value: nfs
              condition: "{{ 'nfs' in installer.storage.backend }}"
            # Configure storage vendor for netapp: https://bugs.launchpad.net/tripleo/+bug/1642948
            - section: volume
              option: vendor_name
              value: NetApp
              condition: "{{ installer.storage.backend.startswith('netapp') }}"

      - name: fetch the deploy input file
        fetch:
            src: "{{ deployer_input }}"
            dest: "{{ inventory_dir }}/{{ deployer_input | basename }}"
            flat: yes
            fail_on_missing: no
