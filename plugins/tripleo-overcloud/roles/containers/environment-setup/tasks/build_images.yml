---
- name: Downloading overcloud container images template
  get_url:
      url: "{{ containers_puddle_base_url.stdout }}/{{ containers_images_template_download_basename }}"
      dest: "{{ containers_images_template_dest_file }}"
      owner: stack
      group: stack

- name: replace docker registry with mirror
  replace:
      dest: "{{ containers_images_template_dest_file }}"
      regexp: '^([ ]*pull_source: ).*'
      replace: '\1{{ install.registry.mirror }}'
      backup: no
  when: install.get('registry', {}).mirror|default(false)
  tags:
      - container-images-patch

- name: replace docker namespace
  replace:
      dest: "{{ containers_images_template_dest_file }}"
      regexp: '^(- imagename: ).*(\/.*)'
      replace: '\1{{ install.registry.namespace }}\2'
      backup: no
  when: install.get('registry', {}).namespace|default(false)
  tags:
      - container-images-patch

- name: get tag of container images
  shell: |
        cat {{ containers_images_template_dest_file }} | awk '/- imagename: / {print $3}' | head -n1 | cut -f 2 -d:
  register: containers_images_tag
  tags:
      - container-images-patch
      - container-images-packages

- name: get docker registry name
  shell: |
      cat {{ containers_images_template_dest_file }} | awk '/pull_source:/ {print $2}' | head -n1 | tr -d ' '
  register: docker_insecure_registry

- name: replace IP with hostname in /etc/sysconfig/docker
  replace:
      dest: /etc/sysconfig/docker
      regexp: '^(INSECURE_REGISTRY=".*)"'
      replace: '\1 --insecure-registry {{ docker_insecure_registry.stdout }}"'
      backup: no
  become: true

- name: restart docker service
  service:
      name: docker
      state: restarted
  become: true

- name: Check if docker is running
  command: systemctl status docker
  ignore_errors: yes
  changed_when: false
  register: service_docker_status

- name: Report status of docker
  fail:
      msg: |
         Service docker is not running.
         Output of `systemctl status docker`:
         {{ service_docker_status.stdout }}
         {{ service_docker_status.stderr }}
  when: service_docker_status | failed

# using the loop below due to #bz1455683
- name: openstack overcloud container image upload
  shell: |
      source /home/stack/stackrc
      openstack overcloud container image upload --verbose --config-file {{ containers_images_template_dest_file }}
  register: image_upload
  until: image_upload.rc == 0
  retries: 5
  when: not install.registry.undercloud.skip
  tags:
      - skip_ansible_lint

- stat:
      path: /etc/yum.repos.d/patched_rpms.repo
  register: patched_rpms
  when: install.container.images.patch
  tags: container-images-patch

- fail:
    msg:
      /etc/yum.repos.d/patched_rpms.repo doesn't exist
  when:
    - install.container.images.patch
    - patched_rpms.stat.exists == False
  tags: container-images-patch

- name: set fact for docker context dir for images patching
  set_fact:
      container_images_patch_dir: "{{ containers_home_dir }}/images_patch"
  when: install.container.images.patch
  tags: container-images-patch

- name: create docker context dir for images patching - required to copy files into the new image
  file:
    path: "{{ container_images_patch_dir }}"
    state: directory
  when: install.container.images.patch
  tags: container-images-patch

- name: populate docker context dir with patched rpms and repo
  shell: |
    cp /etc/yum.repos.d/patched_rpms.repo {{ container_images_patch_dir }}/
    cp -r /patched_rpms {{ container_images_patch_dir }}/
  when: install.container.images.patch
  tags: container-images-patch

- name: tag the original image(s) with 'before_packages_install' and install&replace container image(s)
  shell: |
    docker tag {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item.key }}:{{ containers_images_tag.stdout }} \
    {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item.key }}:{{ containers_images_tag.stdout }}-before_packages_install
    echo "FROM {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item.key }}:{{ containers_images_tag.stdout }}
    RUN yum localinstall {{ item.value.split(",") | join(" ") }} -y -v" | docker build -t {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item.key }}:{{ containers_images_tag.stdout }} -
    docker push {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item.key }}:{{ containers_images_tag.stdout }}
  with_dict: "{{ install.container.images.packages }}"
  tags: container-images-packages

- name: tag the original image(s) with 'before_patching' and patch&replace container image(s)
  shell: |
    docker tag {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item }}:{{ containers_images_tag.stdout }} \
    {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item }}:{{ containers_images_tag.stdout }}-before_patching
    echo "
    FROM {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item }}:{{ containers_images_tag.stdout }}
    COPY patched_rpms.repo /etc/yum.repos.d/patched_rpms.repo
    ADD /patched_rpms /patched_rpms
    RUN yum update -y -v
    " > {{ container_images_patch_dir }}/Dockerfile
    docker build -t {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item }}:{{ containers_images_tag.stdout }} {{ container_images_patch_dir }}/
    docker push {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item }}:{{ containers_images_tag.stdout }}
  with_items: "{{ install.container.images.patch.split(',') }}"
  when: install.container.images.patch
  tags: container-images-patch

- name: Output from uploading images
  debug: var=image_upload
