- name: set container_images_packages_logdir fact
  set_fact:
      container_images_packages_logdir: /var/log/extra/container-images-packages/
  tags: container-images-packages

- name: "create {{ container_images_packages_logdir }} to keep the logs"
  become: true
  file:
      path: "{{ container_images_packages_logdir }}"
      state: "{{ item }}"
  with_items:
      - absent
      - directory
  tags: container-images-packages

- debug:
      var: hostvars[inventory_hostname]
      verbosity: 0
  tags: container-images-packages

- name: tag the original image(s) with 'before_packages_install' and install rpms&push new ones
  become: true
  shell: |
      set -o errexit
      docker tag {{ docker_registry_undercloud }}/{{ basereg_relative }}/{{ item.key }}:{{ container_env['container-image-prepare']['tag'] }} \
      {{ docker_registry_undercloud }}/{{ basereg_relative }}/{{ item.key }}:{{ container_env['container-image-prepare']['tag'] }}-before_packages_install
      echo "FROM {{ docker_registry_undercloud }}/{{ basereg_relative }}/{{ item.key }}:{{ container_env['container-image-prepare']['tag'] }}
      RUN sudo yum localinstall {{ item.value.split(",") | join(" ") }} -y -v" | \
      docker build -t {{ docker_registry_undercloud }}/{{ basereg_relative }}/{{ item.key }}:{{ container_env['container-image-prepare']['tag'] }} - \
      > {{ container_images_packages_logdir }}/docker_build_{{ item.key }}.log

      if ! grep -q "Complete!" "{{ container_images_packages_logdir }}/docker_build_{{ item.key }}.log" ; then
          echo -e "\n\nno packages installed!!!\n\n." >&2
          exit 1
      fi
      docker push {{ docker_registry_undercloud }}/{{ basereg_relative }}/{{ item.key }}:{{ container_env['container-image-prepare']['tag'] }}
  with_dict: "{{ install_container_images_packages }}"
  tags: container-images-packages
