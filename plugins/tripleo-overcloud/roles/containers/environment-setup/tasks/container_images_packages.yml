- name: set container_images_packages_logdir fact
  set_fact:
      container_images_packages_logdir: /var/log/extra/container-images-packages/
  tags: container-images-packages

- name: "create {{ container_images_packages_logdir }} to keep the logs"
  become: true
  file:
      path: "{{ container_images_packages_logdir }}"
      state: "{{ item }}"
  with_items:
      - absent
      - directory
  tags: container-images-packages

- name: tag the original image(s) with 'before_packages_install' and install rpms&push new ones
  become: true
  shell: |
      set -o errexit
      docker tag {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item.key }}:{{ containers_images_tag.stdout }} \
      {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item.key }}:{{ containers_images_tag.stdout }}-before_packages_install
      echo "FROM {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item.key }}:{{ containers_images_tag.stdout }}
      RUN sudo yum localinstall {{ item.value.split(",") | join(" ") }} -y -v" | docker build -t {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item.key }}:{{ containers_images_tag.stdout }} - > {{ container_images_packages_logdir }}/docker_build_{{ item.key }}.log
      if ! grep -q "Complete!" "{{ container_images_packages_logdir }}/docker_build_{{ item }}.log" ; then
          echo -e "\n\nno packages installed!!!\n\n." >&2
          exit 1
      fi
      docker push {{ docker_registry_undercloud }}{{ docker_registry_undercloud_namespace }}/{{ item.key }}:{{ containers_images_tag.stdout }}
  with_dict: "{{ install_container_images_packages }}"
  tags: container-images-packages
