- name: Tag our machines with flavors
  hosts: undercloud
  gather_facts: no
  any_errors_fatal: true
  vars:
      ansible_python_interpreter: "/var/tmp/venv_shade/bin/python"
  tasks:
      - name: Check for the instackenv file
        stat:
            path: "~/instackenv.json"
        register: instack_file_path

      - set_fact:
            instack_file: "{{ instack_file_path.stat.path }}"
        when: instack_file_path.stat.exists

      - fail:
            msg: "instackenv file is missing"
        when: not instack_file_path.stat.exists

      # replace with os_ modules once shade group will be available
      - name: read all flavors
        os_flavor_facts:
            cloud: undercloud
        delegate_to: "{{ groups.shade | first }}"

      - name: remove all the flavors
        os_nova_flavor:
            cloud: undercloud
            state: absent
            name: "{{ item.name }}"
        with_items: "{{ openstack_flavors }}"
        delegate_to: "{{ groups.shade | first }}"
        vars:
            ansible_python_interpreter: "/var/tmp/venv_shade/bin/python"

      - name: create the baremetal flavor for our machines
        os_nova_flavor:
            cloud: undercloud
            state: present
            ram: 4096
            disk: 16
            vcpus: 1
            name: baremetal
        delegate_to: "{{ groups.shade | first }}"

      # OSPd7 doesn't seem to have implicit profile matching and notifies to do this step manually
      # in prior of OC deployment. Otherwise errors and warnings are produced in process when
      # overcloud deployment starts.
      - name: set additional properties
        shell: |
            source ~/stackrc
            openstack flavor set --property 'cpu_arch'='x86_64' --property 'capabilities:boot_option'='local' --property "capabilities:profile"="baremetal" baremetal
        when:
            - install.version|default(undercloud_version)|openstack_release == 7
            - "'hypervisor' not in groups"
            - "'bmc' not in groups"
        tags: skip_ansible_lint

      - name: Set baremetal capability for OSPd7 nodes as it must be done explicitely
        shell: |
            source ~/stackrc
            for node in `ironic node-list | awk '{print $2}' | grep -v "\(ID\|^$\)"`; do ironic node-update $node add properties/capabilities=profile:baremetal,boot_option:local; done
        tags: skip_ansible_lint
        when:
            - install.version|default(undercloud_version)|openstack_release == 7
            - "'hypervisor' not in groups"
            - "'bmc' not in groups"

      - name: read instackenv file
        command: cat "{{ instack_file }}"
        register: overcloud_hosts_facts

      - set_fact:
            overcloud_facts: "{{ overcloud_hosts_facts.stdout | from_json }}"

      # Remember, hostvars are special: https://github.com/ansible/ansible/issues/13838, https://github.com/ansible/ansible/issues/21084
      - name: create the flavors for our machines
        vars:
            flv_min_disk_size: 6
            flv_min_cpu: 1
            flavor_name: "{{ item.name.rstrip('1234567890-').split('-')[-1] }}"
        os_nova_flavor:
            cloud: undercloud
            state: present
            ram: "{{ (hostvars[item.name] | default({})).ram | default(item.memory) }}"
            disk: "{{ [((hostvars[item.name] | default({})).disk | default(item.disk) | int) - 3, flv_min_disk_size] | max }}"
            vcpus: "{{ [((hostvars[item.name] | default({})).vcpus | default(item.cpu) | int) - 1, flv_min_cpu] | max }}"
            name: "{{ flavor_name }}"
            extra_specs:
               "cpu_arch": "x86_64"
               "capabilities:boot_option": "local"
               "capabilities:profile": "{{ flavor_name }}"
        with_items: "{{ overcloud_facts.nodes | default([]) }}"
        delegate_to: "{{ groups.shade | first }}"
        when: "item.name is defined"

      - name: tag our nodes with the proper profile
        vars:
            flavor_name: "{{ item.name.rstrip('1234567890-').split('-')[-1] }}"
        shell: |
           source ~/stackrc
           ironic node-update {{ item.name }} add properties/capabilities='profile:{{ flavor_name }},boot_option:local'
        with_items: "{{ overcloud_facts.nodes | default([]) }}"
        when: "item.name is defined"
