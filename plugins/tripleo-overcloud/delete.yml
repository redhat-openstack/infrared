- name: Delete existing Overcloud
  hosts: undercloud
  gather_facts: yes
  tags: delete
  any_errors_fatal: true
  vars:
    undercloud_version: "{{ install.version | openstack_release }}"
    stack_name: "{{ install.overcloud.stack }}"
  tasks:
      - name: Show details about existing stack "{{ stack_name }}"
        shell: |
            source ~/stackrc
            if openstack stack list | grep -qw "{{ stack_name }}"; then
              openstack stack show "{{ stack_name }}" > openstack_stack_show_"{{ stack_name }}".log
            fi
        args:
          executable: /bin/bash
        changed_when: False

      - name: Delete existing "{{ stack_name }}" Heat stack if it exists
        os_stack:
          name: "{{ stack_name }}"
          state: absent
          register: stack_delete
        until: stack_delete is success
        delay: 5
        retries: 6

      - name: Delete container and objects
        command: >
          openstack container delete "{{ item }}" --recursive
        failed_when:
          - container_objects.rc != 0
          - "'Not Found' not in container_objects.stderr"
        changed_when:
          - "'Not Found' not in container_objects.stderr"
        register: container_objects
        loop:
          - "{{ stack_name }}"
          - "{{ stack_name }}-messages"
          - "{{ stack_name }}-swift-rings"

      - name: Get list of existing baremetal nodes
        shell: |
            source ~/stackrc
            {% if undercloud_version is version('10', '<') %}
            ironic node-list --fields name | tail -n +4 | head -n -1 | awk '{print $2}'
            {% else %}
            openstack baremetal node list -c Name -f value
            {% endif %}
        args:
          executable: /bin/bash
        changed_when: False
        register: _baremetal_node_list

      - name: Delete existing baremetal nodes
        shell: |
            source ~/stackrc
            {% if undercloud_version is version('10', '<') %}
            ironic node-delete {{ item }}
            {% else %}
            openstack baremetal node delete {{ item }}
            {% endif %}
        loop: "{{ _baremetal_node_list.stdout_lines | default([]) }}"
        args:
          executable: /bin/bash
