---
- name: Patch hypervisor for undercloud deployment (if present)
  tags: hypervisor
  include: hypervisor.yml
  when: "'hypervisor' in groups"

- include: init.yml
  tags: init

# FIXME(yfried): dump facts?

- include: setup_packages.yml
  tags: install

# Need to setup virtualenv on shade node after undercloud has got repos configured
- include: shade.yml
  tags: shade

- include: configure.yml
  tags: configure

- include: deploy.yml
  tags: deploy

- name: collect ansible facts
  hosts: all
  tasks:
    - set_fact:
        ansible_facts_dir: "{{ ansible_user_dir }}/ansible_facts"
        ansible_facts_dir_host: "{{ inventory_dir }}/../../../ansible_facts"
        ansible_facts_filename: "infrared_tripleo-undercloud-install_"

    - name: recreate facts directory on inventory hosts
      file:
        path: "{{ ansible_facts_dir }}"
        state: "{{ item }}"
      with_items:
        - absent
        - directory

    - name: save ansible facts in json file
      copy:
        content: "{{ hostvars[inventory_hostname] | to_nice_json }}"
        dest: "{{ ansible_facts_dir }}/{{ansible_facts_filename}}{{ inventory_hostname }}.json"

    - name: recreate facts directory on localhost
      file:
        path: "{{ ansible_facts_dir_host }}"
        state: "{{ item }}"
      when: inventory_hostname == 'localhost'
      with_items:
        - absent
        - directory

    - name: fetch ansible facts file from inventory hosts
      fetch:
        src: "{{ ansible_facts_dir }}/{{ansible_facts_filename}}{{ inventory_hostname }}.json"
        dest: "{{ ansible_facts_dir_host }}/"
        flat: yes
  tags: collect_facts