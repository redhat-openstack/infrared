- name: Installing the undercloud
  tags: deploy
  hosts: undercloud
  any_errors_fatal: true
  tasks:
      - name: install the undercloud
        command: bash ~/undercloud_deploy.sh
        register: undercloud_deployment
        ignore_errors: yes

      - name: print the last 60 lines of the undercloud installation
        command: tail -n60 undercloud_install.log

      - name: print any nested error entries in undercloud installation
        shell: "grep -B2 -A5 -i 'info:.*error:' undercloud_install.log || true"

      - fail:
            msg: "Undercloud deployment failed... :("
        when: undercloud_deployment.rc != 0

      # rhosp-release provides /etc/rhosp-release, which is used in upgrade for version discovery.
      - name: install rhosp-release
        become: true
        package:
            state: latest
            name: rhosp-release
        when:
            - install.version|openstack_distribution == 'OSP'
            - install.version|openstack_release >= 10

      - name: fetch the stackrc file
        tags:
            - fetch_rc_file
        fetch:
            src: "~/stackrc"
            dest: "{{ inventory_dir }}/stackrc"
            flat: yes
            fail_on_missing: yes

      - name: get the undercloud cloud auth variables
        shell: |
            for key in $( set | awk '{FS="="}  /^OS_/ {print $1}' ); do unset $key ; done
            source /home/stack/stackrc
            echo "
            auth_url: $OS_AUTH_URL
            username: $OS_USERNAME
            password: $OS_PASSWORD
            project_name: ${OS_PROJECT_NAME:-$OS_TENANT_NAME}"
        register: cloud_details_uc

      - name: update clouds.yaml file
        blockinfile:
            content: "{{ cloud_auth|to_nice_yaml }}"
            dest: "~/clouds.yaml"
            marker: "# {mark} ANSIBLE MANAGED BLOCK {{ cloud_auth.keys() }}"
            backup: yes
            create: yes
        vars:
          cloud_auth: "{{ cloud_auth_uc|default({}) | combine({'clouds':{'undercloud':{'auth': cloud_details_uc.stdout|from_yaml }}}, recursive=True) }}"

      - name: gathering new facts about the undercloud
        setup:
