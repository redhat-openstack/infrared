- name: Configure Undercloud
  hosts: undercloud
  tags: configure
  gather_facts: no
  any_errors_fatal: true
  tasks:
      - name: install custom CA if needed
        become: yes
        become_user: root
        when:
          - install.tls.ca != ''
        block:
          - name: "fetch {{ install.tls.ca }}"
            get_url:
              url: "{{ install.tls.ca }}"
              dest: /etc/pki/ca-trust/source/anchors/custom-ssl-ca.crt
              validate_certs: no
            register: custom_ca
            retries: 30
            delay: 3

          - name: update system trust store
            when: custom_ca is changed
            command: update-ca-trust
