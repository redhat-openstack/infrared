- name: Check if we have shade node in groups
  hosts: undercloud
  tags: init
  gather_facts: no
  any_errors_fatal: true
  tasks:
      - name: Adding undercloud to the shade group
        add_host:
          name: "{{ inventory_hostname }}"
          groups: "shade"
        when: "'hypervisor' not in groups['shade']"

- name: Prepare shade node
  hosts: shade
  tags: init
  gather_facts: no
  become: yes
  any_errors_fatal: true
  tasks:
      - block:
          - name: install virtualenv requirments for pip
            become: yes
            package:
                name: "{{ item }}"
                state: present
            with_items:
               - python-virtualenv
               - gcc
               - python-devel

          - name: create shade virtualenv
            pip:
                name: "{{ item.key }}"
                version: "{{ item.value }}"
                virtualenv: "{{ path_venv }}"
            with_dict:
                setuptools: "17.0"
                pytz: "2016.4"
                shade: "1.19.0"
                pip: "8.1"
        vars:
            path_venv: "/var/tmp/venv_shade"

- name: Pre Run Adjustments
  hosts: undercloud
  tags: init
  gather_facts: no
  become: yes
  any_errors_fatal: true
  tasks:
    - name: Set selinux state
      selinux:
          policy: "targeted"
          state: "{{ install.selinux|default('enforcing') }}"

    - name: Ensure yum presence
      shell: python -c 'import yum' || (dnf install -y yum yum-utils && ln -snf /usr/bin/yum-deprecated /usr/bin/yum)

    - name: set hostname
      hostname:
          # todo(yfried): this seems highly specific. Refactor this to a more generic use case
          name: "{{ inventory_hostname }}.redhat.local"

    - name: update /etc/hosts with undercloud details
      lineinfile:
          dest: "/etc/hosts"
          line: "127.0.0.1   {{ inventory_hostname }}.redhat.local {{ inventory_hostname }}"
          state: present

- include: create_user.yml
  tags: user

