- name: Pre Run Adjustments
  hosts: undercloud
  tags: init
  gather_facts: no
  become: yes
  any_errors_fatal: true
  tasks:
    - name: Set selinux state
      selinux:
          policy: "targeted"
          state: "{{ install.selinux|default('enforcing') }}"

    - name: Ensure yum presence
      shell: python -c 'import yum' || (dnf install -y yum yum-utils && ln -snf /usr/bin/yum-deprecated /usr/bin/yum)

    - name: set hostname
      hostname:
          # todo(yfried): this seems highly specific. Refactor this to a more generic use case
          name: "{{ inventory_hostname }}.redhat.local"

    - name: update /etc/hosts with undercloud details
      lineinfile:
          dest: "/etc/hosts"
          line: "127.0.0.1   {{ inventory_hostname }}.redhat.local {{ inventory_hostname }}"
          state: present

    - name: export /var/cache/yum over NFS from localhost
      lineinfile:
        path: '/etc/exports'
        line: '/var/cache/yum  *(rw,sync,no_root_squash)'
        state: present
      become: true
      delegate_to: hypervisor

    - name: make sure NFS server is running
      service:
        name: nfs
        state: started
        enabled: true
      become: true
      delegate_to: hypervisor

    - name: try mounting /var/cache/yum over NFS from the host
      mount:
        path: "/var/cache/yum"
        src: "10.0.0.1:/var/cache/yum"
        fstype: "nfs"
        state: mounted
      become: true
      ignore_errors: true

- import_playbook: create_user.yml
  tags: user
