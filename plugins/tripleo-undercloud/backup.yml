- name: TripleO Undercloud Backup
  hosts: undercloud
  gather_facts: yes
  become: true
  tasks:
      - name: Delete previous backup dir just in case
        file:
          path: /backup
          state: absent
      - name: Create backup directory
        file:
          path: /backup
          state: directory
      - name: DB backup
        shell: |
          mysqldump --opt --all-databases > /root/undercloud-all-databases.sql

      - name: Directories backup
        shell: |
          tar --xattrs --ignore-failed-read -cf /backup/undercloud-backup-`date +%F`.tar /root/undercloud-all-databases.sql /etc /var/log  /var/lib/glance  /var/lib/certmonger /var/lib/docker /var/lib/registry  /srv/node /root /home/stack