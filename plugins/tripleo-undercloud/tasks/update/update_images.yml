---
- name: set temp_dir
  set_fact:
    TMP_IMAGE_DIR: "/tmp/TEMP_IMAGES"

- name: create temp directory
  file:
    dest: "{{ TMP_IMAGE_DIR }}"
    mode: 0755
    owner: "{{ install.user.name }}"
    group: "{{ install.user.name }}"
    state: directory

- name: untar images to {{ TMP_IMAGE_DIR }}
  unarchive:
    dest: "{{ TMP_IMAGE_DIR }}"
    src: "{{ item }}"
    remote_src: True
  with_items:
    - "/usr/share/rhosp-director-images/ironic-python-agent-latest-{{ undercloud_version }}.0.tar"
    - "/usr/share/rhosp-director-images/overcloud-full-latest-{{ undercloud_version }}.0.tar"

- name: debug updated images
  debug:
    msg: "{{ new_images }}"

- name: update images in glance
  register: image_upload
  shell: |
    source ~/stackrc && openstack overcloud image upload --update-existing
  args:
    chdir: "{{ TMP_IMAGE_DIR }}"

- name: debug images upload
  debug:
    msg: "{{ image_upload }}"

- name: update deployment kernel and ramdisk
  shell: |
    source ~/stackrc && openstack baremetal configure boot
  args:
    chdir: "{{ TMP_IMAGE_DIR }}"
  register: kr_update

- name: debug kernel/ramdisk update
  debug:
    msg: "{{ kr_update }}"

- name: remove {{ TMP_IMAGE_DIR }}
  become: True
  file:
    dest: "{{ TMP_IMAGE_DIR }}"
    state: absent
  ignore_errors: True
