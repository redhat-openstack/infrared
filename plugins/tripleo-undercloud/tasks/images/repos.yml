---
- name: install libguestfs-tools to get virt-customize
  become: yes
  package:
      name: libguestfs-tools
      state: present

- name: Get patched_rpms and from_source file stat
  vars:
      repo_dir: /etc/yum.repos.d
  stat:
      path: "{{ repo_dir }}/{{ item }}"
  register: patched_rpms
  with_items:
      - patched_rpms.repo
      - from_source.repo

- name: Copy custom repos to tmp overcloud directory
  copy:
      src: "{{ item.stat.path }}"
      dest: "{{ tmp_oc_repos_dir }}"
      remote_src: yes
      force: yes
  when: item.stat.exists
  with_items: "{{ patched_rpms.results }}"

- name: Upload custom repo to overcloud image
  register: image_repos
  shell: |
      repo_path=$(awk -F'file://' '/baseurl/ {print $2}' {{ item.stat.path }})
      for repo in $repo_path;do
          new_repo_path="/${repo##*/}"
          sed -i "s|${repo}|${new_repo_path}|" {{ tmp_oc_repos_dir }}/{{ item.stat.path|basename }}
      done
      virt-copy-in -a {{ overcloud_image_file }} ${repo_path} /
  when: item.stat.exists
  with_items: "{{ patched_rpms.results }}"

- block:
      - name: Enable rhelosp-rhel-server-opt repository
        ini_file:
            path: "{{ tmp_oc_repos_dir }}/rhos-release-rhel-{{ ansible_distribution_version }}.repo"
            section: "rhelosp-rhel-{{ ansible_distribution_version }}-server-opt"
            option: enabled
            value: 1

      - name: Add includepkgs option to rhos-release-rhel
        ini_file:
            path: "{{ tmp_oc_repos_dir }}/rhos-release-rhel-{{ ansible_distribution_version }}.repo"
            section: "rhelosp-rhel-{{ ansible_distribution_version }}-server-opt"
            option: includepkgs
            value: yum-plugin-priorities
  become: yes
  when: install.get('from', {}).source is defined

- name: Push repos to overcloud image
  command: "virt-copy-in -a {{ overcloud_image_file }} {{ tmp_oc_repos_dir }} /etc/"

- name: Install yum-plugin-priorities package inside overcloud image
  command: "virt-customize -a {{ overcloud_image_file }} --install yum-plugin-priorities"
  when: install.get('from', {}).source is defined

- name: Do package update inside of overcloud image
  command: "virt-customize --selinux-relabel --update -a {{ overcloud_image_file }}"

- name: Install packages in overcloud image
  command: "virt-customize -a {{ overcloud_image_file }} --install {{ install.images.packages }} --selinux-relabel"
  register: image_packages
  when: install.images.packages|default(None) != None

# restart libvirt service to avoid possible hangs of virt-customize task.
- name: restart libvirt service
  become: yes
  service:
      name: libvirtd
      state: restarted

- name: update packages on repos
  command: "virt-customize -a {{ overcloud_image_file }} --update --memsize {{ requested_mem }} --smp {{ (ansible_processor_vcpus/2)|round|int }}  --selinux-relabel"
  register: image_update
  vars:
      available_mem: "{{ [ansible_memory_mb.nocache.free, (ansible_memtotal_mb/2)|round|int] | min }}"
      # don't overreach
      safe_mem: "{{ (available_mem|int * 0.6)|round|int }}"
      # don't ask lower than virt-customize default:
      requested_mem: "{{ [safe_mem, 500] | max}}"
  when: install.images['update'] or patched_rpms.results|selectattr('stat.exists', 'equalto', True)|list|length > 0

- name: Set selinux state
  command: "virt-customize -a {{ overcloud_image_file }} --selinux-relabel --run-command 'sed -i s/SELINUX=.*/SELINUX={{ install.selinux }}/g /etc/selinux/config'"
  register: image_selinux
  when:
      - install.selinux is defined
      - install.selinux == 'permissive' or install.selinux =='disabled'

# mcornea: remove once we have a resolution for BZ#1559151
- name: implement workaround for BZ#1559151
  command: "virt-customize -a {{ overcloud_image_file }} --selinux-relabel --delete /usr/libexec/os-apply-config/templates/etc/os-net-config/config.json"
  when:
      - undercloud_version|openstack_release == 11

- name: remove machine-id from overcloud image
  command: "virt-sysprep --operation machine-id -a {{ overcloud_image_file }}"
  when:
      - image_repos is changed or image_packages is changed or image_update is changed or image_selinux is changed
