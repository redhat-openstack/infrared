- name: Update inventory file after adding Undercloud hypervisors group
  hosts: localhost
  gather_facts: yes
  tasks:
      - block:
          - name: set undercloud_hypervisors
            set_fact:
                undercloud_hypervisors: "{{ undercloud_hypervisors|default([]) + [item[1]] }}"
            when: ('ansible_ssh_common_args' in hostvars[item[0]]) and (hostvars[item[1]].ansible_host in hostvars[item[0]].ansible_ssh_common_args)
            with_nested:
                - "{{ groups.undercloud }}"
                - "{{ groups.hypervisor }}"
          - name: add undercloud_hypervisors group
            add_host:
                name: "{{ item }}"
                groups: "{{ hostvars[item].group_names + ['undercloud_hypervisors'] }}"
            with_items: "{{ (undercloud_hypervisors is defined) | ternary(undercloud_hypervisors, []) }}"
          - include_role:
                name: inventory-update
            vars:
                inventory_file_name: 'hosts-prov'
            when: ((undercloud_hypervisors is defined) and
                  (undercloud_hypervisors != []))
          - name: refresh dynamic inventory
            meta: refresh_inventory
        when: "'hypervisor' in groups and 'undercloud' in groups"
        tags:
            - uc_hypervisors
