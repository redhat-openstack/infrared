---
- name: get cloud variables
  shell: |
      for key in $( set | awk '{FS="="}  /^OS_/ {print $1}' ); do unset $key ; done
      source /home/stack/{{cloud}}rc
      echo -n "'auth': { 'auth-url': '$OS_AUTH_URL', 'username': '$OS_USERNAME', 'password': '$OS_PASSWORD', 'project-name': '${OS_PROJECT_NAME:-$OS_TENANT_NAME}' }"
  register: cloud_details

- name: create clouds.yaml if doesn't exist
  blockinfile:
      content: 'clouds:'
      dest: "~/clouds.yaml"
      marker: "#{mark} HEADER"
      create: yes

- name: insert cloudname in clouds.yaml
  blockinfile:
      block: |4
              {{cloud}}:
      dest: "~/clouds.yaml"
      insertbefore: "#END HEADER"
      marker: "#{mark} {{ cloud }} SECTION"
    
- name: insert cloud parameters
  blockinfile:
      dest: "~/clouds.yaml"
      block: |4
               {{ cloud_details.stdout|from_yaml|to_nice_yaml(indent=8) }}
      insertbefore: "#END {{ cloud }} SECTION"
      marker: "#{mark} {{ cloud }} PARAMETERS"