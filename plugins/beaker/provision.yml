---
- name: Use beaker to provision/release the machine
  hosts: localhost
  vars_files:
    - "vars/image/{{ provision.image }}.yml"
  tasks:
    - name: Provisioning the machine
      beaker_provisioner:
          url: "{{ provision.url }}"
          username: "{{ provision.beaker.user }}"
          password: "{{ provision.beaker.password }}"
          host: "{{ provision.host.address }}"
          action: "provision"
          distro_tree_id: "{{ distro_id }}"
          web_service: "{{ provision.web.service }}"
          ca_cert: "{{ (provision.ca|default({})).cert | default(omit) }}"
#      when: provision_please is defined

    - name: Add the host to host list
      add_host:
          name: "{{ provision.host.address }}"
          groups: "baremetal"
          ansible_ssh_host: "{{ provision.host.address }}"
          ansible_ssh_user: "{{ provision.host.user }}"
          ansible_ssh_pass: "{{ provision.host.password }}"

    - name: wait for ssh
      wait_for:
          port: 22
          host: "{{ provision.host.address }}"
          search_regex: OpenSSH
      delay: 10

- name: generate inventory file
  hosts: localhost
  gather_facts: no
  tags: always
  tasks:
    - name: generate inventory file
      template:
        dest: "{{ inventory_dir }}/hosts-prov"
        src: templates/inventory.j2
        force: yes

    - name: update inventory file symlink
      file:
        dest: "{{ inventory_dir }}/hosts"
        state: link
        src: "hosts-prov"

- name: Enable SSH access to provisioned host
  hosts: baremetal
  gather_facts: no
#  any_errors_fatal: true
  tasks:
    - debug: msg="{{ provision.inject.keyfile }}"

    - name: Inject our public SSH key to the autorized_keys
      authorized_key:
          user: "{{ provision.host.user }}"
          key: "{{ lookup('file', provision.inject.keyfile ) }}"
      when: provision.inject.keyfile is defined

    - name: Remove SSH password and use PKI from now on
      add_host:
          name: "{{ provision.host.address }}"
          ansible_ssh_pass: None
          ansible_ssh_private_key_file: "{{ provision.inject.keyfile }}"
      when: provision.inject.keyfile is defined
