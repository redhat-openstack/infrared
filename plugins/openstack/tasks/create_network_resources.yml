- name: Include setting for security groups
  include_vars: 
      file: 'vars/sg/{{ sg_name }}.yml'
      name: security_group

- name: Create security group
  vars:
      resources: "{{ lookup('file', inventory_dir + '/resources.yml') | from_yaml }}"
  os_security_group:
      cloud: "{{ provision.cloud | default(omit) }}"
      state: present
      name: "{{ security_group.name }}"
      description: Scurity group created by Infrared

- name: Add rules to the security group
  vars:
      resources: "{{ lookup('file', inventory_dir + '/resources.yml') | from_yaml }}"
  os_security_group_rule:
      cloud: "{{ provision.cloud | default(omit) }}"
      security_group: "{{ security_group.name }}"
      direction: "{{ item.direction }}"
      ethertype: "{{ item.ethertype }}"
      remote_ip_prefix: "{{ item.remote_ip_prefix }}"
      protocol: "{{ item.protocol|default(omit) }}"
      port_range_min: "{{ item.port_range_min|default(omit) }}"
      port_range_max: "{{ item.port_range_max|default(omit) }}"
  with_items: "{{ security_group.rules }}"