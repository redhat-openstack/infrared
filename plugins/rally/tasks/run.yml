# TODO (tjamrisk): Need to somehow skip this if deployment exists
#- name: Create Rally deployment
#  shell: |
#      source ~/overcloudrc
#      {{ rally.path }}/bin/rally deployment create --fromenv --name {{ test.deployment }} | awk '/{{ test.deployment }}/ {print $2}'
#  register: rally_deployment_uuid
#  ignore_errors: true
#
#- name: Use Rally deployment
#  shell: |
#      {{ rally.path }}/bin/rally deployment use {{ test.deployment }} | awk '/Using deployment/ {print $3}'
#  register: rally_deployment_uuid
#  when: "'Deployment' in rally_deployment_uuid.stdout"

- name: Check if rally test is compatible with rally version
  vars:
      required_rally_version: '0.10'
  fail:
      msg: |
          The {{ test.tests }} test requires rally version {{ required_rally_version }} or later.
          Installed version is {{ rally_version.stdout }}, please use install type '--setup git' 
          to get latest version of rally.
  when:
      - rally_version.stdout | version_compare(required_rally_version, '<')
      - test.tests | basename  == item
  with_items:
      - 'nova-rally.yml'

- name: Create Rally deployment
  shell: |
      test -f ~/overcloudrc.v3 && source ~/overcloudrc.v3 || source ~/overcloudrc
      {{ rally.bin }} deployment create --fromenv --name {{ test.deployment }} | awk '/{{ test.deployment }}/ {print $2}'
  register: rally_deployment_uuid
  ignore_errors: true

- name: Use Rally deployment
  shell: |
      {{ rally.bin }} deployment use {{ test.deployment }} | awk '/Using deployment/ {print $3}'
  register: rally_deployment_uuid
  when: "'Deployment' in rally_deployment_uuid.stdout"

- name: Ensures {{ rally.dir }}/rally-jobs dir exists
  file: path={{ rally.dir }}/rally-jobs state=directory

- name: Copy Task file from vars
  template:
      src: "{{ test.tests }}"
      dest: "{{ rally.dir }}/{{ test.taskfile }}"
      force: yes

- name: Check Rally deployment
  command: "{{rally.bin}} deployment check"

- name: Start Rally task
  command: "{{rally.bin}} task start --task {{ rally.dir }}/{{ test.taskfile }}"
  ignore_errors: yes
