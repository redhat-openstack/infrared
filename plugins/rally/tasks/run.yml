- name: List Rally deployments
  shell: |
      set -exo pipefail
      {{ rally.bin }} db ensure
      {{ rally.bin }} deployment list
  register: rally_deployment_list

- name: Create Rally deployment if it does not exist
  shell: |
      set -exo pipefail
      test -f ~/overcloudrc.v3 && source ~/overcloudrc.v3 || source ~/overcloudrc
      echo $OS_AUTH_URL | grep https > /dev/null && export OS_INSECURE=True || true
      {{ rally.bin }} deployment create --fromenv --name {{ test.deployment }}
  when: "'{{ test.deployment }}' not in rally_deployment_list.stdout"

- name: Use Rally deployment if it exists
  shell: |
      {{ rally.bin }} deployment use {{ test.deployment }}
  when: "'{{ test.deployment }}' in rally_deployment_list.stdout"

- name: Ensures {{ rally.dir }}/rally-jobs dir exists
  file:
      path: "{{ rally.dir }}/rally-jobs"
      state: "directory"

- name: Copy Task file from vars
  template:
      src: "{{ test.tests }}"
      dest: "{{ rally.dir }}/{{ test.taskfile }}"
      force: yes

- name: Check Rally deployment
  command: "{{ rally.bin }} deployment check"

- name: Start Rally task
  command: "{{ rally.bin }} task start --task {{ rally.dir }}/{{ test.taskfile }}"
  ignore_errors: yes
