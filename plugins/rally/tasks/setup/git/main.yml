- name: Install devel packages for package build dependencies
  become: yes
  package:
      name: "{{ setup.packages }}"
      state: present

- name: Install pip using get-pip.py
  shell: |
      curl https://bootstrap.pypa.io/get-pip.py | python
  become: true
  when: setup.pip_packages is defined

- name: Install required pip packages
  pip:
      name: "{{ package_list }}"
      state: latest
  become: yes
  vars:
    package_list: >-
      {%- set package_list = [] %}
      {%- for package in setup.pip_packages %}
      {%-   if ir_default_pip_versions[package] is defined %}
      {%-     set _ = package_list.append(package ~ '==' ~ ir_default_pip_versions[package]) %}
      {%-   else %}
      {%-     set _ = package_list.append(package) %}
      {%-   endif %}
      {%- endfor %}
      {{- package_list -}}

- name: Clone Rally from git repo
  git:
      repo: "{{ test.git.repo | try_default(rally.git.repo) }}"
      version: "{{ test.git.revision | try_default(rally.git.revision) }}"
      dest: "{{ rally.dir }}"

- name: Clone Rally-Plugins git repo
  vars:
  git:
      repo: "{{ test.git.plugins.repo | try_default(rally.git.plugins.repo) }}"
      version: "{{ test.git.plugins.revision| try_default(rally.git.plugins.revision) }}"
      dest: "{{ rally.git.plugins.dir }}"
  when: test.git.plugins.repo is defined and test.git.plugins.repo != ""

- name: Run Rally installation script
  shell: "{{ rally.dir }}/install_rally.sh -v -y -d {{ rally.path }} | tee {{ rally.dir }}/rally_install.log"
  args:
      creates: "{{ rally.bin }}"

- name: List rally version
  shell: "{{ rally.bin }} --version |& cut -d '~' -f1"
  register: rally_version

- name: List rally release
  shell: "{{ rally.bin }} --version |& cut -d '~' -f2"
  register: rally_release

- name: Install rally-openstack package
  pip:
      name: "{{ package_list }}"
      state: latest
      virtualenv: "{{ rally.path }}"
  vars:
    package_list: >-
      {%- set package_list = [] %}
      {%- for package in packages %}
      {%-   if ir_default_pip_versions[package] is defined %}
      {%-     set _ = package_list.append(package ~ '==' ~ ir_default_pip_versions[package]) %}
      {%-   else %}
      {%-     set _ = package_list.append(package) %}
      {%-   endif %}
      {%- endfor %}
      {{- package_list -}}
    packages:
      - prettytable
      - cryptography
      - oslo.utils
      - oslo.i18n
      - git+git://git.openstack.org/openstack/rally-openstack@master
      - kubernetes
      - openstacksdk
  become: yes
  when: "{{ rally_version.stdout | version_compare('1.0.0', '>=') }}"

- debug:
      msg: "Build mark: rally={{ rally_version.stdout }}-{{ rally_release.stdout }}"
