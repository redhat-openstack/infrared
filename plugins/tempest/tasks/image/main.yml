---
- name: define backend settings
  set_fact:
      libguestfs_backend: direct

- name: Install libguestfs-tools
  become: yes
  package:
      name: libguestfs-tools
      state: present

- name: Download tempest image
  get_url:
      dest: "~/tempest_image"
      url: "{{ test.image }}"

- name: Push repos to guest image tempest will use for testing
  environment:
      LIBGUESTFS_BACKEND: "{{ libguestfs_backend }}"
  command: "virt-copy-in -a ~/tempest_image /etc/yum.repos.d /etc/"

- name: Disable 'patched-rpms' yum repository in guest image
  environment:
      LIBGUESTFS_BACKEND: "{{ libguestfs_backend }}"
  command: "virt-customize -a ~/tempest_image --run-command \"yum-config-manager --disable patched-rpms\""
  failed_when: false

- name: Install packages in guest image tempest will use for testing
  environment:
      LIBGUESTFS_BACKEND: "{{ libguestfs_backend }}"
  command: "virt-customize -a ~/tempest_image --install {{ test.images.packages }} --selinux-relabel"
 
- block:
    - name: Create a custom script file to upload to tempest image
      copy:
          content: "{{ test.images.script }}"
          dest: "~/tempest_image_script"

    - name: Upload and execute a custom script inside tempest guest image
      environment:
          LIBGUESTFS_BACKEND: "{{ libguestfs_backend }}"
      shell: |
          virt-customize -a ~/tempest_image --upload ~/tempest_image_script:~/script.sh
          virt-customize -a ~/tempest_image --run-command 'chmod +x ~/script.sh && ~/script.sh' --selinux-relabel
  when: test.images.script is defined