---
- name: find openstackrc file
  find:
      file_type: file
      pattern: "{{ test.openstackrc | basename }}"
      paths:
          - "{{ lookup('env', 'PWD') }}/{{ test.openstackrc | dirname }}"
          - "{{ test.openstackrc | expanduser | dirname }}"
  register: openstackrc_find
  delegate_to: localhost
  when: test.openstackrc|default('')

- name: fail when rc file was not found
  fail:
      msg: "Unable to find rc file: {{ test.openstackrc }}"
  when: test.openstackrc|default('') and openstackrc_find.matched == 0

- name: copy openstackrc file
  copy:
      src: "{{ openstackrc_find.files[0].path }}"
      dest: "~/keystonerc"
      force: yes
  when: test.openstackrc|default('')

- name: copy default keystonerc from active profile
  copy:
      src: "{{ inventory_dir }}/keystonerc"
      dest: "~/keystonerc"
      force: yes
  when: not test.openstackrc|default('')

- name: find deployer-input file
  find:
      pattern: "{{ test.deployer.input.file | basename }}"
      paths:
          - "{{ lookup('env', 'PWD') }}/{{ test.deployer.input.file | dirname }}"
          - "{{ test.deployer.input.file | expanduser | dirname }}"
  register: deployer_find
  delegate_to: localhost
  when: test.deployer.input.file is defined

- name: fail when deployer file was not found
  fail:
      msg: "Unable to find deployer input file: {{ test.deployer.input.file }}"
  when: test.deployer.input.file is defined and deployer_find.matched == 0

- name: copy the tempest-deployer-input to the tester
  copy:
      src: "{{ deployer_find.files[0].path }}"
      dest: "{{ deployer_input }}"
      backup: yes
  when: test.deployer.input.file is defined

- name: run configuration tasks for installer '{{ test.openstack.installer }}'
  include: "{{ test.openstack.installer }}.yml"
