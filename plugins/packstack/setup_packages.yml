---
- name: Setup openstack repos
  hosts: openstack_nodes
  gather_facts: yes
  become: yes
  any_errors_fatal: true
  roles:
      - role: rhos-release
        rhos_release_rpm: https://url.corp.redhat.com/rhos-release-latest-rpm
        release: "{{ install.version }}"
        build: "{{ install.build }}"
        mirror: "{{ install.mirror | default(omit) }}"
        enable_testing_repos: "{{ install.get('enable', {}).get('testing', {}).repos|default(omit) }}"
  tasks:
      - name: enable repo for testing puddle
        shell: |
            yum-config-manager \
            --enable rhelosp-{{ install.version }}.0-test-deps >/var/log/yum.log \

      - name: Update all packages
        package:
            name: "*"
            state: latest

      - name: Enable patched_rpms repository
        yum_repository:
            enabled: true
            name: patched_rpms
        when: patch is defined
