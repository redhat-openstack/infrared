---
- name: Create networks
  hosts: hypervisor
  gather_facts: yes
  any_errors_fatal: true
  tasks:
    - name: load the network topology file
      find:
          patterns: "{{ provision.topology.network }}.yml"
          paths:
              # search here first
              - vars/topology/network
              # search here later
              - defaults/topology/network
      register: topology_file
      delegate_to: localhost

    - include_vars: "{{ topology_file.files[0].path }}"

    - name: check for existing networks
      virt_net:
          command: "list_nets"
      register: network_list

    - name: create the networks for the topology
      virt_net:
          command: "define"
          name: "{{ item.value.name }}"
          xml: "{{ lookup('template', 'templates/network.xml.j2') }}"
      when: "item.value.name not in network_list.list_nets"
      with_dict: "{{ networks }}"

    - name: check if network is active
      virt_net:
          name: "{{ item.value.name }}"
          state: active
          autostart: yes
      with_dict: "{{ networks }}"
