# TODO: this is prepared in recursive form to be able not only to remove
# basic read only snapshots (v1) but also clones in future (v2)
- name: Iterating over the following image
  ansible.builtin.debug:
    msg: "{{ rbd_image }}"

- name: Test whether the RBD image has snapshots (read only copies)
  shell: |
      rbd snap ls --pool {{ provision.rbd.pool }} --namespace {{ provision.rbd.namespace }} {{ rbd_image }} | sed '1d' | awk '{print $2}'
  register: rbd_snapshots

- name: Test whether the RBD image has children (clones)
  shell: |
      rbd children --pool {{ provision.rbd.pool }} --namespace {{ provision.rbd.namespace }} {{ rbd_image }} --format  json
  register: _rbd_clones

- name: Create yaml of clone details
  ansible.builtin.set_fact:
    rbd_clones: "{{ _rbd_clones.stdout | from_json }}"

- name: The image has following snapshots
  ansible.builtin.debug:
    msg: "The image has following snapshots: {{ rbd_snapshots.stdout_lines }}"

- name: The image has following children/clones
  ansible.builtin.debug:
    msg: "The image has following clones: {{ rbd_clones }}"

- name: 2Remove images one by one
  include_tasks: rbd_remove_image_recursive.yml
  with_list: "{{ rbd_clones | map(attribute='image') | list }}"
  loop_control:
      loop_var: rbd_image
  when: rbd_clones

- name: Remove all snapshots
  shell: |
      echo "Removing snapshot {{ item }} for image {{ rbd_image }}"
      rbd snap unprotect --pool {{ provision.rbd.pool }} --namespace {{ provision.rbd.namespace }} {{ rbd_image }}@{{ item }} || true
      rbd snap rm --pool {{ provision.rbd.pool }} --namespace {{ provision.rbd.namespace }} {{ rbd_image }}@{{ item }}
  with_list: "{{ rbd_snapshots.stdout_lines }}"

- name: Finally remove the image itself
  shell: |
      echo "Removing the RBD image {{ rbd_image }} now"
      rbd rm --pool {{ provision.rbd.pool }} --namespace {{ provision.rbd.namespace }} {{ rbd_image }}
