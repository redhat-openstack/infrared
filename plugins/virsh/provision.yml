---
- name: Pre run configuration
  include: "{{ provision_pre | default('pre.yml') }}"
  tags: pre

- name: Prepare the hypervisor for provisioning
  include: "{{ prepare_hypervisor | default('prepare_hypervisor.yml') }}"
  tags: hypervisor

- name: Create Networks
  include: "{{ provision_networks | default('provision_networks.yml') }}"
  tags: networks

- name: Provision Vms
  include: "{{ provision_vms | default('provision_vms.yml') }}"
  tags: vms

- name: Create a sudoer user for non root SSH login
  include: "{{ provision_user | default('provision_user.yml') }}"
  tags: user

- name: Including post provision tasks
  include: "{{ provision_post | default('post.yml') }}"
  tags: post

- name: generate inventory file
  hosts: localhost
  gather_facts: no
  tags: always
  tasks:
    - name: generate inventory file
      template:
        dest: "{{ inventory_dir }}/hosts-prov"
        src: templates/inventory.j2
        force: yes

    - name: update inventory file symlink
      file:
        dest: "{{ inventory_dir }}/hosts"
        state: link
        src: "hosts-prov"

- name: collect ansible facts
  hosts: all
  tasks:
    - set_fact:
        ansible_facts_dir: "{{ ansible_user_dir }}/ansible_facts"
        ansible_facts_dir_host: "{{ inventory_dir }}/../../../ansible_facts"
        ansible_facts_filename: "infrared_virsh_provision_"

    - name: recreate facts directory on inventory hosts
      file:
        path: "{{ ansible_facts_dir }}"
        state: "{{ item }}"
      with_items:
        - absent
        - directory

    - name: save ansible facts in json file
      copy:
        content: "{{ hostvars[inventory_hostname] | to_nice_json }}"
        dest: "{{ ansible_facts_dir }}/{{ansible_facts_filename}}{{ inventory_hostname }}.json"

    - name: recreate facts directory on localhost
      file:
        path: "{{ ansible_facts_dir_host }}"
        state: "{{ item }}"
      when: inventory_hostname == 'localhost'
      with_items:
        - absent
        - directory

    - name: fetch ansible facts file from inventory hosts
      fetch:
        src: "{{ ansible_facts_dir }}/{{ansible_facts_filename}}{{ inventory_hostname }}.json"
        dest: "{{ ansible_facts_dir_host }}/"
        flat: yes
  tags: collect_facts