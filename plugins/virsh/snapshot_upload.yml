---
- name: Upload snapshots of virtual machines
  hosts: "{{ (_run_condition | bool) | ternary('hypervisor', 'none') }}"
  gather_facts: yes
  any_errors_fatal: true
  tasks:
    - name: Prepare swiftclient venv
      pip:
        name:
          - "openstacksdk"
          - "python-keystoneclient"
          - "python-swiftclient"
        virtualenv: "~/.swiftclient"
        state: present

    - name: Create the required container in object storage
      vars:
        ansible_python_interpreter: "~/.swiftclient/bin/python"
      os_object:
        container: "{{ provision.virsh.snapshot.container }}"
      environment:
        OS_PROJECT_ID: "{{ lookup('env', 'OS_PROJECT_ID') }}"
        OS_USERNAME: "{{ lookup('env', 'OS_USERNAME') }}"
        OS_PASSWORD: "{{ lookup('env', 'OS_PASSWORD') }}"
        OS_USER_DOMAIN_NAME: "{{ lookup('env', 'OS_USER_DOMAIN_NAME') }}"
        OS_AUTH_URL: "{{ lookup('env', 'OS_AUTH_URL') }}"
        OS_IDENTITY_API_VERSION: "{{ lookup('env', 'OS_IDENTITY_API_VERSION') }}"
      register: _create_container
      until: _create_container is success
      retries: 10
      delay: 30

    # The ansible os_object module does not currently support threaded uploads
    # (which make this much faster), nor does it support setting a segment
    # size (for large files), so we use the swift client instead. We use
    # a segment size of 1GB.
    - name: Upload the snapshot path folder to object storage
      shell: |
        source ~/.swiftclient/bin/activate
        swift upload {{ provision.virsh.snapshot.container }} {{ provision.virsh.snapshot.path | basename }} --object-threads 100 --skip-identical --segment-size 1073741824
      args:
        executable: "/bin/bash"
        chdir: "{{ provision.virsh.snapshot.path | dirname }}"
      environment:
        OS_PROJECT_ID: "{{ lookup('env', 'OS_PROJECT_ID') }}"
        OS_USERNAME: "{{ lookup('env', 'OS_USERNAME') }}"
        OS_PASSWORD: "{{ lookup('env', 'OS_PASSWORD') }}"
        OS_USER_DOMAIN_NAME: "{{ lookup('env', 'OS_USER_DOMAIN_NAME') }}"
        OS_AUTH_URL: "{{ lookup('env', 'OS_AUTH_URL') }}"
        OS_IDENTITY_API_VERSION: "{{ lookup('env', 'OS_IDENTITY_API_VERSION') }}"
      register: _upload_result
      retries: 10
      delay: 30
      until: _upload_result is success

    - name: Clean up swiftclient venv
      file:
        path: "~/.swiftclient"
        state: absent
