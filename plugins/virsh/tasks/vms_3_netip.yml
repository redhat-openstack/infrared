---
# save current node to "{{ node_dict }}"
- name: get node_dict
  include: var_lookup.yml
  vars:
      var_file: "{{ node.key }}"
      partial_path: topology/nodes

include: tasks/tunnled_network.yml
when: not node_dict.external_network.bridged|default(False)


# We can write nodes to inventory while we wait for ips
- name: add hosts to host list
  add_host:
      name: "{{ item.item[0].cmd.split()[2] }}"
      groups: "{{ node_dict.groups | join(',') }}"
      ansible_ssh_user: "root"
      ansible_ssh_host: "{{ item.stdout | ipaddr('address') }}"
      ansible_ssh_private_key_file: "{{ inventory_dir }}/id_rsa"
      ansible_ssh_common_args: "
          -o ForwardAgent=yes
          -o ServerAliveInterval=30
          -o ControlMaster=auto
          -o ControlPersist=30m
          -o StrictHostKeyChecking=no
          -o UserKnownHostsFile=/dev/null
          -o ProxyCommand=\"ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -W %h:%p -i {{ ansible_ssh_private_key_file }} {{ ansible_ssh_user }}@{{ ansible_ssh_host }}\""
  with_items: "{{ vm_ip_list }}"
when: not node_dict.external_network.bridged|default(False)
