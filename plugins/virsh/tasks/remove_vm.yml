---
- name: destroy undefined vms
  virt:
      name: "{{ vm_name }}"
      state: destroyed

- name: undefine relevant VMs
  command: "virsh undefine --nvram {{ vm_name }}"

- name: Clean /etc/hosts file
  become: yes
  lineinfile:
      dest: /etc/hosts
      regexp: ".*{{ vm_name }}.*"
      state: absent

- name: cleanup known-hosts by name
  known_hosts:
      state: absent
      name: "{{ vm_name }}"
  ignore_errors: yes

- name: find existing VM disks that we created
  find:
      paths: "{{ provision.disk.pool }}"
      patterns: "{{ vm_name }}*disk*.qcow*"
  register: vmdisk_files

- name: remove any existing VM disks that we created
  file:
      path: "{{ item.path }}"
      state: absent
  with_items: "{{ vmdisk_files.files }}"
