---
- name: destroy undefined vms
  virt:
      name: "{{ vm_name }}"
      state: destroyed

- name: undefine relevant VMs
  command: "virsh undefine --nvram {{ vm_name }}"

- name: Clean /etc/hosts file
  become: yes
  lineinfile:
      dest: /etc/hosts
      regexp: ".*{{ vm_name }}.*"
      state: absent

- name: cleanup known-hosts by name
  known_hosts:
      state: absent
      name: "{{ vm_name }}"
  ignore_errors: yes

- name: find existing VM disks that we created (qcow)
  find:
      paths: "{{ provision.disk.pool }}"
      patterns: "{{ vm_name }}*disk*.qcow*"
  register: vmdisk_qcow_files

- name: find existing VM disks that we created (raw)
  find:
      paths: "{{ provision.disk.pool }}"
      patterns: "{{ vm_name }}*disk*.raw"
  register: vmdisk_raw_files

- name: remove any existing VM disks that we created (qcow)
  file:
      path: "{{ item.path }}"
      state: absent
  with_items:
      - "{{ vmdisk_qcow_files.files }}"
      - "{{ vmdisk_raw_files.files }}"
