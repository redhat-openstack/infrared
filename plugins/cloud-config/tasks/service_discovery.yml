---
- fail:
      msg: "{{ item }} not found in service map"
  when: service_map[item] is not defined

- name: Get service node
  command: source ~/overcloudrc && {{ service_map[item].command }}
  register: service_info

- name: Add hosts to inventory
  add_host:
      name: "{{ host }}"
      groups: "{{ hostvars[host].group_names + [ service_map[item].group ] }}"
  vars:
      host: "{{ service_info.stdout }}"
