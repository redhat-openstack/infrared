- name: Install tempest from rpm
  become: yes
  yum:
      name: "openstack-tempest"
      state: present
  register: tempest_rpm

- name: list tempest version
  become: yes
  command: "rpm -q --qf %{VERSION} openstack-tempest"
  register: tempest_rpm_version

- name: list tempest release
  become: yes
  command: "rpm -q --qf %{RELEASE} openstack-tempest"
  register: tempest_rpm_release

- debug: "msg='Build mark: tempest={{ tempest_rpm_version.stdout }}-{{ tempest_rpm_release.stdout }}'"

- name: install test plugins
  include: install_plugins.yml
  with_dict: "{{ tester.testsÂ }}"
  loop_control:
      loop_var: test_suite

- name: Install junitxml
  become: yes
  yum:
      name: "python-junitxml"
      state: present

# TODO(psedlak): make subunit2junitxml usage opt. in script, add the flag for run-tests.sh in run.yml after that
- name: Install subunit filters - needed for subunit2junitxml
  become: yes
  yum:
      name: "subunit-filters"
      state: present

- name: Install test dependency
  become: yes
  yum:
      name: "{{ item }}"
      state: present
  with_items: "{{ tester.setup.dependencies }}"
  when: openstack_version|int >= 10

- name: Create the tempest directory
  file:
      dest: "{{ tester.dir }}"
      state: directory

- name: Get the script which configures the tempest directory
  shell: ls -d /usr/share/openstack-tempest-*/tools/configure-tempest-directory
  register: configure_tempest_dir
  ignore_errors: true

- name: Initialize tempest workspace directory using configure-tempest-directory
  command: "{{ configure_tempest_dir.stdout_lines[0] }}"
  args:
      chdir: "~/{{ tester.dir }}"
      creates: "~/{{ tester.dir }}/LICENSE"
  when: configure_tempest_dir.rc == 0

- name: Install tempestconf if config script is not part of tempest
  become: yes
  yum:
      name: python-tempestconf
      state: present
  when: configure_tempest_dir.rc != 0

- name: Initialize tempest workspace directory using tempest init
  command: "tempest init"
  args:
      chdir: "~/{{ tester.dir }}"
      creates: "~/{{ tester.dir }}/etc"
  when: configure_tempest_dir.rc != 0

- name: run tempest configuration tool
  vars:
      deployer_input: "{{ '(result | success)' | ternary('--deployer-input ~/tempest-deployer-input.conf', '') }}"
      orchestration: "{{ (installer.type == 'ospd') | ternary('orchestration.stack_owner_role heat_stack_owner', '') }}"
      region: "{{ (installer.type == 'ospd') | ternary('identity.region regionOne', '') }}"
      config_options: "{{ tester.get('config', {}).get('options', {}) }}"
  shell: |
      source ~/keystonerc
      if [ -f /usr/bin/discover-tempest-config ]; then
        export TEMPESTCONF="/usr/bin/discover-tempest-config"
      else
        export TEMPESTCONF="tools/config_tempest.py"
      fi
      ${TEMPESTCONF} {{ deployer_input }} --debug \
      --create identity.uri $OS_AUTH_URL \
      {# custom global config options #}
      {% for name,value in config_options.iteritems() %}
      {{ name }} {{ value }} \
      {% endfor %}
      {# insert test suite config options #}
      {% for suite_name,suite_params in tester.tests.iteritems() %}
      {% for name, value in suite_params.get('config_options', {}).iteritems() %}
      {{ name }} {{ value }} \
      {% endfor %}
      {% endfor %}
      identity.admin_password $OS_PASSWORD {{ orchestration }} {{ region }}
  args:
      chdir: "~/{{ tester.dir }}"
