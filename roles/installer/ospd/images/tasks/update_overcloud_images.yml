---
- name: install libguestfs-tools to get virt-customize
  become: yes
  yum:
      name: libguestfs-tools
      state: present

- name: tmp repos.d for overcloud
  file:
      name: "{{ tmp_oc_repos_dir }}"
      state: directory

# TODO(psedlak): use installer/rhos-release / mirror urls (do we want it here?)
- name: "create overcloud build's repos locally"
  rhos_release:
      state: install
      core_version: "{{ installer.product.core.version }}"
      core_build_date: "{{ installer.product.core.build }}"
      target_directory: "{{ tmp_oc_repos_dir }}"
  register: command_result
  until: command_result.stderr.find('Connection reset by peer') == -1
  retries: 40
  delay: 5

- name: push core repos to overcloud image
  shell: "virt-copy-in -a {{ overcloud_image_file }} {{ tmp_oc_repos_dir }} /etc/"

- name: Install u/s opendaylight RPM package
  shell: "virt-customize -a {{ overcloud_image_file }} --run-command 'yum -y localinstall http://cbs.centos.org/repos/nfv7-opendaylight-5-testing/x86_64/os/Packages/opendaylight-5.2.0-0.1.20161121rel1586.el7.noarch.rpm'"

- name: Install packages in overcloud image
  shell: "virt-customize -a {{ overcloud_image_file }} --install {{ installer.images.packages }}"
  when: installer.images.packages is defined and installer.images.packages != None

- name: update overcloud core bits to build's latest
  shell: "virt-customize {% if installer.images['update'] == 'verbose' %}-v{% endif %} -a {{ overcloud_image_file }} --update --selinux-relabel"
