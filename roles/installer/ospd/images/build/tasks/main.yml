---
- name: Create overcloud_images directory
  file: path={{ image_build_path }} state=directory

- name: Download guest image for build
  get_url:
      dest: "{{ image_build_path }}/guest_image.qcow2"
      url: "{{ installer.images.overcloud.guest_image }}"

- name: Build OC images
  shell: |
      pushd ~/overcloud_images
      openstack overcloud image build --type {{ item.value }} > openstack-build-images-{{ item.value }}.log
  with_dict: "{{ installer.images.overcloud.files }}"
  environment:
      DIB_LOCAL_IMAGE: "{{ image_build_path }}/guest_image.qcow2"
      DIB_YUM_REPO_CONF: "/etc/yum.repos.d/rhos-release-{{ product.version.major }}-director.repo /etc/yum.repos.d/rhos-release-{{ product.version.major }}.repo /etc/yum.repos.d/rhos-release-rhel-{{ private.distro.rhel.full_version }}.repo"
      RHOS: 1
      RUN_RHOS_RELEASE: 1
      RHOS_RELEASE: "{{ product.version.major }}-director"
      USE_DELOREAN_TRUNK: 0
