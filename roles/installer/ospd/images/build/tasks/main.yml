---
- fail: msg="Check is image build path is defined"
  when: image_build_path is not defined

- name: Create overcloud_images directory
  file: path={{ image_build_path }} state=directory

- name: Download guest image for build
  get_url:
      dest: "{{ image_build_path }}/guest_image.qcow2"
      url: "{{ installer.images.overcloud.guest_image }}"

- name: Build OC images
  shell: |
      pushd ~/overcloud_images
      openstack overcloud image build --all > openstack-build-images.log
  environment:
      DIB_LOCAL_IMAGE: "{{ image_build_path }}/guest_image.qcow2"
      DIB_YUM_REPO_CONF: "/etc/yum.repos.d/rhos-release-{{ product.version.major }}-director.repo /etc/yum.repos.d/rhos-release-{{ product.version.major }}.repo /etc/yum.repos.d/rhos-release-rhel-{{ distro.full_version }}.repo"
      RHOS: 1
      RUN_RHOS_RELEASE: 1
      RHOS_RELEASE: "{{ product.version.major }}_director"
      USE_DELOREAN_TRUNK: 0
# TODO: Add portal credentials and repositories - not working so far - invalid credentials
#      REG_METHOD: portal
#      REG_USER: "{{ private.distro.rhel.subscription.username }}"
#      REG_PASSWORD: "{{ private.distro.rhel.subscription.password }}"
#      REG_POOL_ID: "{{ private.distro.rhel.subscription.pool }}"
#      REG_REPOS: "rhel-7-server-rpms rhel-7-server-extras-rpms rhel-ha-for-rhel-7-server-rpms rhel-7-server-optional-rpms rhel-7-server-openstack-7.0-rpms"
