- name: get node details
  shell: |
      source ~/stackrc
      ironic --json node-show {{ item }}
  with_items: "{{ groups['overcloud_nodes'] }}"
  register: ironic_nodes

- name: update node capabilities with node name
  shell: >
      source ~/stackrc;
      ironic node-update {{ (item | from_json)['name'] }} replace
      properties/capabilities='node:{{ (item | from_json)['name'] }},{{ (item | from_json)['properties']['capabilities'] }}'
  with_items: "{{ ironic_nodes.results | map(attribute='stdout') | list }}"

- name: prepare hostname template
  template:
      src: "hostnames.yml.j2"
      dest: "{{ template_base }}/hostnames.yml"

- name: append the hostnames template line to the base overcloud deploy script
  lineinfile:
      dest: "~/overcloud_deploy.sh"
      line: '-e {{ template_base }}/hostnames.yml \'
