---
- name: Register management subnet details
  os_subnets_facts:
      cloud: "{{ provisioner.cloud | default(omit) }}" 
      filters:
          name: "{{ prefix }}management"
  delegate_to: localhost
  become: no
  register: management_subnet_details

- name: Set fact for management subnet - default gateway
  set_fact:
      management_default_gateway: "{{ item.value[0].gateway_ip }}"
  with_dict: "{{ management_subnet_details.ansible_facts }}"

- name: Set fact for management subnet - CIDR prefix
  set_fact:
      management_cidr_prefix: "{{ item | ipaddr('prefix') }}"
  with_items: "{{ provisioner.neutron.subnets.management.cidr }}"

- name: Ensure /etc/os-net-config directory exists
  file:
      path="/etc/os-net-config"
      state="directory"

- name: Deploy os-net-config configuration
  template:
      src="os-net-config.j2"
      dest="/etc/os-net-config/config.yaml"
