# This file is used once per node in 'overcloud_nodes' group
# Node type can be: controller, compute, ceph, etc.
- name: Set fact for node type
  set_fact:
      node_type: "{{ item }}"

- os_server_facts:
      cloud: "{{ provisioner.cloud | default(omit) }}"
      server: "{{ prefix }}{{ node_type.value.name }}-{{ item }}"
  register: openstack_servers
  delegate_to: localhost
  become: no
  with_sequence: "count={{ node_type.value.amount }}"

- name: Deploy openstack-bmc service file
  template:
      src="openstack-bmc-service.j2"
      dest="/usr/lib/systemd/system/openstack-bmc-{{ prefix }}{{ node_type.value.name }}-{{ item }}.service"
  with_sequence: "count={{ node_type.value.amount }}"
  when: "'overcloud_nodes' in node_type.value.groups"

- name: Start the service for the node '{{ node_type.key }}'
  service:
      name="openstack-bmc-{{ prefix}}{{ node_type.value.name }}-{{ item }}.service"
      state=started
      enabled=yes
  with_sequence: "count={{ node_type.value.amount }}"
  when: "'overcloud_nodes' in node_type.value.groups"
