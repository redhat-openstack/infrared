{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "bcf6d131_f8375d8e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1014339
      },
      "writtenOn": "2022-06-27T09:44:28Z",
      "side": 1,
      "message": "Seems plugins/tripleo-overcloud/templates/compute-dvr.yaml.j2 and plugins/tripleo-overcloud/tasks/network.yml may also need update if those are used along the nic config changed in this patch ",
      "revId": "ebde64571c1d650c291d9810a27052a89abdfca3",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "22e710be_470d24af",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1004639
      },
      "writtenOn": "2022-06-27T12:11:57Z",
      "side": 1,
      "message": "I\u0027ve tested a composable deployment, created a vm and assigned a fip but the ping entirely failed:\n\n2022-06-24 15:21:54 | [Fri Jun 24 03:21:54 PM UTC 2022] Finished OVN controller update\n2022-06-24 15:21:54 | 11 packets transmitted, 0 received, +9 errors, 100% packet loss, time 10241ms\n2022-06-24 15:21:54 | pipe 4\n2022-06-24 15:21:54 | Ping loss higher than 0 seconds detected (6 seconds)\n\nThe HA version is working.\nOSP17 version tested.",
      "revId": "ebde64571c1d650c291d9810a27052a89abdfca3",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8df75552_6f81ef46",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1016950
      },
      "writtenOn": "2022-06-27T12:21:41Z",
      "side": 1,
      "message": "do you have a live environment to take a look?",
      "parentUuid": "22e710be_470d24af",
      "revId": "ebde64571c1d650c291d9810a27052a89abdfca3",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5d1d0ca6_de21f177",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1016950
      },
      "writtenOn": "2022-06-27T12:25:25Z",
      "side": 1,
      "message": "or maybe some details? dvr/no-dvr? list of templates used",
      "parentUuid": "8df75552_6f81ef46",
      "revId": "ebde64571c1d650c291d9810a27052a89abdfca3",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "77d57974_6ada545a",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1016950
      },
      "writtenOn": "2022-06-27T17:44:44Z",
      "side": 1,
      "message": "OK, I succeeded to reproduce the ping issue. Actually it\u0027s not related directly to the patch, there is something that should be fixed in composable_roles existing templates since the ping does not work also when deploying a dvr environment without the patch.\nI tried to deploy normal dvr networking-ovn osp17 job with composable roles and ping did not work until I created br-ex on compute nodes by\nsudo ovs-vsctl add-br br-ex -- set bridge br-ex fail-mode\u003dstandalone\nsudo ovs-vsctl add-port br-ex enp3s0\n\nTried also to deploy upgrades DFG job (only deploy, no upgrade) DFG-upgrades-updates-17.0-from-passed_phase1-composable-ipv6 as is, without using this patch, result: also no ping to VMs. \nI\u0027ll try to check tomorrow how it can be fixed but the ping issue is not a result of the patch. Something is wrong in the current state of the composable_roles templates.",
      "parentUuid": "5d1d0ca6_de21f177",
      "revId": "ebde64571c1d650c291d9810a27052a89abdfca3",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "3151e3d0_a597cd92",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1014339
      },
      "writtenOn": "2022-06-28T05:28:36Z",
      "side": 1,
      "message": "@roman, @sathlan can you also share job logs where with/without this patch have failures, i can also have a look at those.",
      "parentUuid": "77d57974_6ada545a",
      "revId": "ebde64571c1d650c291d9810a27052a89abdfca3",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "16dcc3c0_4643988e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1016950
      },
      "writtenOn": "2022-06-28T06:42:49Z",
      "side": 1,
      "message": "@ykarel Sure, I am currently testing without the patch\n\nTriggered networking-ovn normal osp17 job but replaced \u0027virt\u0027 in OVERCLOUD_DEPLOYMENT_FILES to \u0027composable_roles\u0027 and also added \u0027--role-files Controller,Compute\u0027 to OVERCLOUD_DEPLOY_OVERRIDE_OPTIONS.\n https://rhos-ci-jenkins.lab.eng.tlv2.redhat.com/view/DFG/view/network/view/networking-ovn/job/DFG-network-networking-ovn-17.0_director-rhel-virthost-3cont_2comp-ipv4-geneve-gate-ovn/87/\nResult: no br-ex on compute nodes, no ping to VM from external network (tested with VM directly connected to external network). After adding br-ex manually (as mentioned above) ping worked.\n\nTriggered the updrade DFG job (deploy only, no upgrade) on the playground jenkins\nhttp://staging-jenkins2-qe-playground.usersys.redhat.com/view/DFG/view/upgrades/view/update/job/DFG-upgrades-updates-17.0-from-passed_phase1-composable-ipv6/2/\nResult: no ping to VM connected to external network. IIRC there was also no br-ex on computes so I added br-ex but still there was no ping to the VM. Then I tried to create a router, internal network, VM on the internal network + FIP, then ping to FIP worked.\n\nI also tried to run with modified compute.j2.j2 that ends with the following (in order to create br-ex automatically in case of dvr)\n{% if install.network.dvr|bool or install.network.force.compute.dvr|bool %}\n- type: ovs_bridge\n  {% raw -%}\n  name: {{ neutron_physical_bridge_name }}\n{% endraw %}\n  use_dhcp: false\n  members:\n  - type: interface\n    name: nic3\n    primary: true\n{% else %}\n- type: interface\n  name: nic3\n  use_dhcp: false\n{% endif %}\n\nWorked fine for normal networking-ovn job, br-ex on compute nodes created, VM on external network was pingable out-of-the-box as well as on internal network (via FIP). The live environment is still available if needed.\nhttp://staging-jenkins2-qe-playground.usersys.redhat.com/view/DFG/view/network/view/networking-ovn/job/DFG-network-networking-ovn-17.0_director-rhel-virthost-3cont_2comp-ipv4-geneve-gate-ovn/18/\n\nBut this did not help for the upgrade DFG job, for some reason overcloud deploy failed due to ntp issue on a messaging node. Still need investigation. Live environment is available on a devnest host (10.9.95.129, usual devnest credentials). Feel free to take a look, I will be afk for about 3 hours.\nhttp://staging-jenkins2-qe-playground.usersys.redhat.com/view/DFG/view/upgrades/view/update/job/DFG-upgrades-updates-17.0-from-passed_phase1-composable-ipv6/6/",
      "parentUuid": "3151e3d0_a597cd92",
      "revId": "ebde64571c1d650c291d9810a27052a89abdfca3",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "41823793_025a4f0b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1014339
      },
      "writtenOn": "2022-06-28T09:03:27Z",
      "side": 1,
      "message": "@roman, okk good, wrt br-ex yes that\u0027s needed in case of dvr, i see you have fixed that in past for three-nic-vlan config[1], and now also needs to be fixed for composable_roles, but that doesn\u0027t look related to this patch.\nIf some dvr composable roles jobs were passing earlier, then need to find how.\n\nwrt upgrade job issue, i checked env and found it suffered from random issue https://bugzilla.redhat.com/show_bug.cgi?id\u003d2084075, i reran overcloud_deploy.sh and that succeeded, i just checked br-ex was there on compute node, you can take over if anything else needs to be checked.\n\n[1] https://review.gerrithub.io/c/redhat-openstack/infrared/+/529840",
      "parentUuid": "16dcc3c0_4643988e",
      "revId": "ebde64571c1d650c291d9810a27052a89abdfca3",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "1194c6d5_c1a97eb9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1016950
      },
      "writtenOn": "2022-06-28T13:01:08Z",
      "side": 1,
      "message": "@ykarel, thanks, I\u0027ve made a separate patch for fixing DVR on composable OSP17\nhttps://review.gerrithub.io/c/redhat-openstack/infrared/+/540579\nTBH, it\u0027s not clear to me why compute nodes in tripleo-heat-templates are not connected to External network, at least ComputeDVR role should be connected but it does not https://github.com/openstack/tripleo-heat-templates/blob/master/roles/ComputeDVR.yaml\nThat\u0027s why we have to use DVR workarounds in infrared. Maybe should open a BZ or maybe I am missing something.\nCan it be that if compute node have external_bridge tag it will create an external bridge and attach the node to external network dynamically, even if it not listed under networks: ? According to the link ComputeDVR is connected only to InternalApi, Tenant and Storage networks.",
      "parentUuid": "41823793_025a4f0b",
      "revId": "ebde64571c1d650c291d9810a27052a89abdfca3",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "259e6ad8_7a82b095",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1014339
      },
      "writtenOn": "2022-06-28T14:00:40Z",
      "side": 1,
      "message": "@roman considering [1][2] i think having external_bridge tag is enough, also network-config in tripleo-ansible honors external_bridge[3], so it needs both external_bridge tag in role and utilizing that tag in nic config to create external bridge conditionally.\nAnd what i see nic configs in infrared not using external_bridge tags. \n\n[1] https://opendev.org/openstack/tripleo-heat-templates/commit/bc5b6133f1f192c7fe5330bc1fa13f8259eb9050\n[2] https://opendev.org/openstack/tripleo-heat-templates/commit/ff7cce93ebcdf4fd868329be94d618f9e755049f\n[3] https://github.com/openstack/tripleo-ansible/search?q\u003dexternal_bridge\u0026type\u003d",
      "parentUuid": "1194c6d5_c1a97eb9",
      "revId": "ebde64571c1d650c291d9810a27052a89abdfca3",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "30afcf0d_5ac82763",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 5
      },
      "lineNbr": 0,
      "author": {
        "id": 1004639
      },
      "writtenOn": "2022-06-29T13:54:36Z",
      "side": 1,
      "message": "Removing the -1 as the follow up of that discussion.  Currently testing  https://review.gerrithub.io/c/redhat-openstack/infrared/+/540579 for my issue.",
      "revId": "ebde64571c1d650c291d9810a27052a89abdfca3",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    }
  ]
}